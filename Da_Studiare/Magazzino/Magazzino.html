<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Magazzino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Roboto', sans-serif; }
        .material-card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        .material-card:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            transform: translateY(-2px);
        }
        .material-card-elevated {
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:active::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: ripple-animation 0.6s ease-out;
        }
        @keyframes ripple-animation {
            to { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    </style>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react">
        const { useMemo, useState, useEffect } = React;

        // Variabili globali per i dati
        let PERIODO = "";
        let PRODOTTI = [];
        let CATEGORIE = [];
        let PDF_ANALISI = "";
        let MP3_ANALISI = "";

        function numberFmt(val) {
            return val.toLocaleString("it-IT", {
                style: "currency",
                currency: "EUR",
                maximumFractionDigits: 0
            });
        }

        function qtyFmt(val) {
            return val.toLocaleString("it-IT", {
                maximumFractionDigits: 0
            });
        }

        function pctFmt(val) { return `${val.toFixed(1)}%`; }

        function calcVariance(actual, target) {
            if (!target) return 0;
            return ((actual - target) / target) * 100;
        }

        const STATUS_COLORS = {
            "OK": "bg-green-100 text-green-800",
            "Attenzione": "bg-amber-100 text-amber-800",
            "Critico": "bg-red-100 text-red-800",
            "Eccesso": "bg-blue-100 text-blue-800"
        };

        const STATUS_ICONS = {
            "OK": <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>,
            "Attenzione": <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>,
            "Critico": <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>,
            "Eccesso": <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
        };

        function MagazzinoDashboard() {
            const [selectedCategoria, setSelectedCategoria] = useState("Tutti");
            const [selectedStatus, setSelectedStatus] = useState("Tutti");
            const [selectedProdotto, setSelectedProdotto] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);

            // Carica dati dal JSON
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const dataFile = urlParams.get('data') || 'Magazzino.json';
                PDF_ANALISI = urlParams.get('pdf') || '';
                MP3_ANALISI = urlParams.get('mp3') || '';

                console.log(`Caricamento dati da: ${dataFile}`);
                console.log(`PDF Analisi: ${PDF_ANALISI || 'Non specificato'}`);
                console.log(`MP3 Analisi: ${MP3_ANALISI || 'Non specificato'}`);

                fetch(dataFile)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - File non trovato: ${dataFile}`);
                        }
                        return response.json();
                    })
                    .then(jsonData => {
                        PERIODO = jsonData.Periodo;
                        PRODOTTI = jsonData.Prodotti;
                        CATEGORIE = jsonData.Categorie || [];
                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Errore caricamento dati:', err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            const kpiSummary = useMemo(() => {
                if (!data) return null;

                const totProdotti = PRODOTTI.length;
                const totGiacenza = PRODOTTI.reduce((sum, p) => sum + p.GiacenzaAttuale, 0);
                const totValoreGiacenza = PRODOTTI.reduce((sum, p) => sum + (p.GiacenzaAttuale * p.CostoUnitario), 0);
                const avgRotazione = PRODOTTI.reduce((sum, p) => sum + p.IndiceRotazione, 0) / totProdotti;
                const avgCopertura = PRODOTTI.reduce((sum, p) => sum + p.GiorniCopertura, 0) / totProdotti;

                const prodottiCritici = PRODOTTI.filter(p => p.Stato === "Critico").length;
                const prodottiAttenzione = PRODOTTI.filter(p => p.Stato === "Attenzione").length;
                const prodottiEccesso = PRODOTTI.filter(p => p.Stato === "Eccesso").length;
                const prodottiOK = PRODOTTI.filter(p => p.Stato === "OK").length;

                return {
                    totProdotti,
                    totGiacenza,
                    totValoreGiacenza,
                    avgRotazione,
                    avgCopertura,
                    prodottiCritici,
                    prodottiAttenzione,
                    prodottiEccesso,
                    prodottiOK
                };
            }, [data]);

            const filteredProdotti = useMemo(() => {
                if (!data) return [];
                let filtered = PRODOTTI;

                if (selectedCategoria !== "Tutti") {
                    filtered = filtered.filter(p => p.Categoria === selectedCategoria);
                }

                if (selectedStatus !== "Tutti") {
                    filtered = filtered.filter(p => p.Stato === selectedStatus);
                }

                return filtered;
            }, [selectedCategoria, selectedStatus, data]);

            if (loading) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
                            <div className="text-xl font-medium text-gray-700">Caricamento dati magazzino...</div>
                            <div className="text-sm text-gray-500 mt-2">Attendere prego</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center max-w-md material-card-elevated bg-white rounded-lg p-8">
                            <svg className="w-16 h-16 text-red-500 mx-auto mb-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <div className="text-xl font-medium mb-3 text-red-600">Errore caricamento dati</div>
                            <div className="text-gray-700 mb-4">{error}</div>
                            <div className="text-sm text-gray-500">Assicurati che il file JSON sia presente nella directory.</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full min-h-screen bg-gray-50">
                    {/* Material Design AppBar */}
                    <div className="bg-gradient-to-r from-orange-600 to-orange-700 text-white shadow-lg">
                        <div className="max-w-7xl mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20 2H4c-1 0-2 .9-2 2v3.01c0 .72.43 1.34 1 1.69V20c0 1.1 1.1 2 2 2h14c.9 0 2-.9 2-2V8.7c.57-.35 1-.97 1-1.69V4c0-1.1-1-2-2-2zm-5 12H9v-2h6v2zm5-7H4V4h16v3z"/>
                                    </svg>
                                    <div>
                                        <h1 className="text-xl font-medium">Dashboard Magazzino - Giacenze & Rotazione</h1>
                                        <p className="text-sm text-orange-100">Periodo: {PERIODO} · Valuta: EUR</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded text-sm font-medium">
                                        {kpiSummary.totProdotti} SKU
                                    </div>
                                </div>
                            </div>
                            {(selectedCategoria !== "Tutti" || selectedStatus !== "Tutti") && (
                                <div className="mt-3 flex items-center gap-2 text-sm text-orange-100">
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                    </svg>
                                    <span>Panoramica</span>
                                    {selectedCategoria !== "Tutti" && (
                                        <>
                                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                            </svg>
                                            <span className="font-medium text-white">{selectedCategoria}</span>
                                        </>
                                    )}
                                    {selectedStatus !== "Tutti" && (
                                        <>
                                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                            </svg>
                                            <span className="font-medium text-white">{selectedStatus}</span>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-6 space-y-6">

                    {/* Sezione Analisi - Mostrata solo se c'è almeno un file */}
                    {(PDF_ANALISI || MP3_ANALISI) && (
                        <div className="material-card bg-white rounded-lg p-6">
                            <div className="flex items-center gap-3 mb-4">
                                <svg className="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                                </svg>
                                <h2 className="text-xl font-medium text-gray-900">Analisi</h2>
                            </div>
                            <div className={`grid grid-cols-1 ${PDF_ANALISI && MP3_ANALISI ? 'md:grid-cols-2' : ''} gap-4`}>
                                {/* PDF Link */}
                                {PDF_ANALISI && (
                                    <a
                                        href={PDF_ANALISI}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="flex items-center gap-3 p-4 bg-gradient-to-r from-red-50 to-red-100 rounded-lg hover:from-red-100 hover:to-red-200 transition-all ripple group"
                                    >
                                        <div className="bg-red-600 text-white p-3 rounded-lg group-hover:scale-110 transition-transform">
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/>
                                            </svg>
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900">Analisi Riassuntiva (PDF)</div>
                                            <div className="text-sm text-gray-600">Rapporto completo gestione magazzino</div>
                                        </div>
                                        <svg className="w-5 h-5 text-red-600 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                        </svg>
                                    </a>
                                )}

                                {/* MP3 Link */}
                                {MP3_ANALISI && (
                                    <a
                                        href={MP3_ANALISI}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="flex items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg hover:from-purple-100 hover:to-purple-200 transition-all ripple group"
                                    >
                                        <div className="bg-purple-600 text-white p-3 rounded-lg group-hover:scale-110 transition-transform">
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
                                            </svg>
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900">Podcast Analisi (MP3)</div>
                                            <div className="text-sm text-gray-600">Commento audio stato magazzino</div>
                                        </div>
                                        <svg className="w-5 h-5 text-purple-600 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                        </svg>
                                    </a>
                                )}
                            </div>
                        </div>
                    )}

                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-orange-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Valore Giacenza</div>
                                <svg className="w-6 h-6 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 2H4c-1 0-2 .9-2 2v3.01c0 .72.43 1.34 1 1.69V20c0 1.1 1.1 2 2 2h14c.9 0 2-.9 2-2V8.7c.57-.35 1-.97 1-1.69V4c0-1.1-1-2-2-2zm-5 12H9v-2h6v2zm5-7H4V4h16v3z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{numberFmt(kpiSummary.totValoreGiacenza)}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                {qtyFmt(kpiSummary.totGiacenza)} pezzi totali
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-blue-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Rotazione Media</div>
                                <svg className="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{kpiSummary.avgRotazione.toFixed(1)}x</div>
                            <div className="mt-3 text-sm text-gray-500">
                                Vendite annue / Giacenza media
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-purple-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Copertura Media</div>
                                <svg className="w-6 h-6 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{Math.round(kpiSummary.avgCopertura)} gg</div>
                            <div className="mt-3 text-sm text-gray-500">
                                Giorni di vendite coperte
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-red-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Prodotti Critici</div>
                                <svg className="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-red-600">{kpiSummary.prodottiCritici}</div>
                            <div className="mt-3 flex items-center gap-2 text-sm">
                                <span className="text-amber-600 font-medium">{kpiSummary.prodottiAttenzione} attenzione</span>
                                <span className="text-gray-400">·</span>
                                <span className="text-green-600 font-medium">{kpiSummary.prodottiOK} OK</span>
                            </div>
                        </div>
                    </div>

                    {/* Filtri */}
                    <div className="material-card bg-white rounded-lg p-4 space-y-4">
                        <div>
                            <div className="text-sm font-medium text-gray-700 mb-2">Categoria</div>
                            <div className="flex flex-wrap gap-2">
                                {["Tutti", ...CATEGORIE].map((cat) => {
                                    const isActive = selectedCategoria === cat;
                                    const count = cat === "Tutti" ? PRODOTTI.length : PRODOTTI.filter(p => p.Categoria === cat).length;
                                    return (
                                        <button key={cat} onClick={() => setSelectedCategoria(cat)}
                                            className={`ripple px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${isActive ? "bg-orange-600 text-white shadow-lg" : "bg-gray-100 text-gray-800 hover:bg-gray-200"}`}>
                                            {cat} ({count})
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                        <div>
                            <div className="text-sm font-medium text-gray-700 mb-2">Stato Scorte</div>
                            <div className="flex flex-wrap gap-2">
                                {["Tutti", "Critico", "Attenzione", "OK", "Eccesso"].map((status) => {
                                    const isActive = selectedStatus === status;
                                    const count = status === "Tutti" ? PRODOTTI.length : PRODOTTI.filter(p => p.Stato === status).length;
                                    return (
                                        <button key={status} onClick={() => setSelectedStatus(status)}
                                            className={`ripple px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap flex items-center gap-2 ${isActive ? "bg-orange-600 text-white shadow-lg" : "bg-gray-100 text-gray-800 hover:bg-gray-200"}`}>
                                            {status !== "Tutti" && STATUS_ICONS[status]}
                                            {status} ({count})
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Tabella Prodotti */}
                    <div className="material-card bg-white rounded-lg p-6">
                        <div className="flex items-center gap-3 mb-4">
                            <svg className="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"/>
                            </svg>
                            <h2 className="text-xl font-medium text-gray-900">Prodotti ({filteredProdotti.length})</h2>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50">
                                    <tr className="text-left border-b-2 border-orange-500">
                                        <th className="py-4 px-4 font-medium text-gray-700 uppercase text-xs tracking-wide">Prodotto</th>
                                        <th className="py-4 px-4 font-medium text-gray-700 uppercase text-xs tracking-wide">Categoria</th>
                                        <th className="py-4 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Giacenza</th>
                                        <th className="py-4 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Scorta Sicur.</th>
                                        <th className="py-4 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Rotazione</th>
                                        <th className="py-4 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Copertura</th>
                                        <th className="py-4 px-4 text-center font-medium text-gray-700 uppercase text-xs tracking-wide">Stato</th>
                                        <th className="py-4 px-4"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredProdotti.map((prod, idx) => {
                                        return (
                                            <tr key={idx} className="border-b border-gray-100 hover:bg-orange-50 cursor-pointer transition-colors"
                                                onClick={() => { setSelectedProdotto(prod); setDrawerOpen(true); }}>
                                                <td className="py-3 px-4">
                                                    <div className="font-medium text-gray-900">{prod.Nome}</div>
                                                    <div className="text-xs text-gray-500">SKU: {prod.SKU}</div>
                                                </td>
                                                <td className="py-3 px-4 text-gray-600">{prod.Categoria}</td>
                                                <td className="py-3 px-4 text-right font-semibold text-gray-900">{qtyFmt(prod.GiacenzaAttuale)}</td>
                                                <td className="py-3 px-4 text-right text-gray-600">{qtyFmt(prod.ScortaSicurezza)}</td>
                                                <td className="py-3 px-4 text-right font-medium text-blue-600">{prod.IndiceRotazione.toFixed(1)}x</td>
                                                <td className="py-3 px-4 text-right text-gray-600">{prod.GiorniCopertura} gg</td>
                                                <td className="py-3 px-4 text-center">
                                                    <span className={`inline-flex items-center gap-1 px-3 py-1 rounded-lg text-xs font-medium ${STATUS_COLORS[prod.Stato]}`}>
                                                        {STATUS_ICONS[prod.Stato]}
                                                        {prod.Stato}
                                                    </span>
                                                </td>
                                                <td className="py-3 px-4 text-right">
                                                    <svg className="w-5 h-5 text-orange-600 inline-block" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                                    </svg>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Material Bottom Sheet */}
                    {drawerOpen && selectedProdotto && (
                        <div className="fixed inset-0 z-50 animate-fadeIn">
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={() => setDrawerOpen(false)} />
                            <div className="absolute bottom-0 left-0 w-full h-[80vh] bg-white shadow-2xl overflow-hidden animate-slideUp">
                                <div className="bg-gradient-to-r from-orange-600 to-orange-700 text-white px-6 py-5 shadow-md">
                                    <div className="flex items-start justify-between gap-4">
                                        <div className="flex-1">
                                            <div className="text-xs text-orange-100 uppercase tracking-wide">Dettaglio Prodotto</div>
                                            <h2 className="text-2xl font-medium mt-1">{selectedProdotto.Nome}</h2>
                                            <p className="text-sm text-orange-100 mt-1">SKU: {selectedProdotto.SKU} · {selectedProdotto.Categoria}</p>
                                            <div className="mt-2">
                                                <span className={`inline-flex items-center gap-1 px-3 py-1 rounded-lg text-xs font-medium ${STATUS_COLORS[selectedProdotto.Stato]}`}>
                                                    {STATUS_ICONS[selectedProdotto.Stato]}
                                                    {selectedProdotto.Stato}
                                                </span>
                                            </div>
                                        </div>
                                        <button
                                            className="ripple bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all"
                                            onClick={() => setDrawerOpen(false)}
                                        >
                                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                            </svg>
                                            <span className="font-medium">Chiudi</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="p-6 overflow-y-auto h-[calc(100%-140px)]">
                                    <div className="space-y-6">
                                        {/* KPI Prodotto */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div className="bg-orange-50 p-4 rounded-lg">
                                                <div className="text-sm text-gray-600 mb-2">Giacenza Attuale</div>
                                                <div className="text-2xl font-bold text-orange-600">{qtyFmt(selectedProdotto.GiacenzaAttuale)}</div>
                                            </div>
                                            <div className="bg-amber-50 p-4 rounded-lg">
                                                <div className="text-sm text-gray-600 mb-2">Scorta Sicurezza</div>
                                                <div className="text-2xl font-bold text-amber-600">{qtyFmt(selectedProdotto.ScortaSicurezza)}</div>
                                            </div>
                                            <div className="bg-blue-50 p-4 rounded-lg">
                                                <div className="text-sm text-gray-600 mb-2">Rotazione</div>
                                                <div className="text-2xl font-bold text-blue-600">{selectedProdotto.IndiceRotazione.toFixed(1)}x</div>
                                            </div>
                                            <div className="bg-purple-50 p-4 rounded-lg">
                                                <div className="text-sm text-gray-600 mb-2">Copertura</div>
                                                <div className="text-2xl font-bold text-purple-600">{selectedProdotto.GiorniCopertura} gg</div>
                                            </div>
                                        </div>

                                        {/* Dettagli Economici */}
                                        <div className="material-card-elevated rounded-lg p-6 bg-white">
                                            <h3 className="text-lg font-medium text-gray-900 mb-4">Dati Economici</h3>
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between py-2 border-b">
                                                    <span className="text-sm text-gray-600">Costo Unitario</span>
                                                    <span className="text-lg font-semibold text-gray-900">{numberFmt(selectedProdotto.CostoUnitario)}</span>
                                                </div>
                                                <div className="flex items-center justify-between py-2 border-b">
                                                    <span className="text-sm text-gray-600">Valore Giacenza</span>
                                                    <span className="text-lg font-semibold text-orange-600">
                                                        {numberFmt(selectedProdotto.GiacenzaAttuale * selectedProdotto.CostoUnitario)}
                                                    </span>
                                                </div>
                                                <div className="flex items-center justify-between py-2">
                                                    <span className="text-sm text-gray-600">Vendite Mensili (media)</span>
                                                    <span className="text-lg font-semibold text-gray-900">{qtyFmt(selectedProdotto.VenditeMensili)}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Analisi Rotazione */}
                                        <div className="material-card-elevated rounded-lg p-6 bg-white">
                                            <h3 className="text-lg font-medium text-gray-900 mb-4">Analisi Rotazione</h3>
                                            <div className="space-y-4">
                                                <div>
                                                    <div className="flex items-center justify-between mb-2">
                                                        <span className="text-sm text-gray-600">Indice di Rotazione</span>
                                                        <span className="text-lg font-bold text-blue-600">{selectedProdotto.IndiceRotazione.toFixed(1)}x / anno</span>
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                                        <div
                                                            className={`h-full rounded-full transition-all ${selectedProdotto.IndiceRotazione >= 12 ? 'bg-green-500' : selectedProdotto.IndiceRotazione >= 6 ? 'bg-blue-500' : selectedProdotto.IndiceRotazione >= 3 ? 'bg-amber-500' : 'bg-red-500'}`}
                                                            style={{ width: `${Math.min(selectedProdotto.IndiceRotazione * 5, 100)}%` }}
                                                        />
                                                    </div>
                                                    <div className="mt-2 text-xs text-gray-500">
                                                        {selectedProdotto.IndiceRotazione >= 12 ? "Rotazione Eccellente (>12x)" :
                                                         selectedProdotto.IndiceRotazione >= 6 ? "Rotazione Buona (6-12x)" :
                                                         selectedProdotto.IndiceRotazione >= 3 ? "Rotazione Normale (3-6x)" :
                                                         "Rotazione Lenta (<3x)"}
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4 mt-4">
                                                    <div className="text-center p-3 bg-gray-50 rounded">
                                                        <div className="text-xs text-gray-500">Giorni Copertura</div>
                                                        <div className="text-xl font-bold text-gray-900">{selectedProdotto.GiorniCopertura}</div>
                                                    </div>
                                                    <div className="text-center p-3 bg-gray-50 rounded">
                                                        <div className="text-xs text-gray-500">Lead Time Fornitura</div>
                                                        <div className="text-xl font-bold text-gray-900">{selectedProdotto.LeadTimeFornitura} gg</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Livelli Scorte */}
                                        <div className="material-card-elevated rounded-lg p-6 bg-white">
                                            <h3 className="text-lg font-medium text-gray-900 mb-4">Livelli Scorte</h3>
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-600">Giacenza Massima</span>
                                                    <span className="text-sm font-medium text-gray-900">{qtyFmt(selectedProdotto.GiacenzaMassima)}</span>
                                                </div>
                                                <div className="relative pt-1">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="text-xs text-gray-500">Livello attuale vs capacità</div>
                                                        <div className="text-xs font-semibold text-gray-700">
                                                            {pctFmt((selectedProdotto.GiacenzaAttuale / selectedProdotto.GiacenzaMassima) * 100)}
                                                        </div>
                                                    </div>
                                                    <div className="overflow-hidden h-4 text-xs flex rounded-lg bg-gray-200 relative">
                                                        {/* Giacenza attuale */}
                                                        <div
                                                            style={{ width: `${(selectedProdotto.GiacenzaAttuale / selectedProdotto.GiacenzaMassima) * 100}%` }}
                                                            className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-orange-500"
                                                        />
                                                        {/* Linea scorta sicurezza */}
                                                        <div
                                                            style={{ left: `${(selectedProdotto.ScortaSicurezza / selectedProdotto.GiacenzaMassima) * 100}%` }}
                                                            className="absolute top-0 bottom-0 w-1 bg-red-600"
                                                            title="Scorta di sicurezza"
                                                        />
                                                    </div>
                                                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                                                        <span>0</span>
                                                        <span className="text-red-600">Sicurezza: {qtyFmt(selectedProdotto.ScortaSicurezza)}</span>
                                                        <span>Max: {qtyFmt(selectedProdotto.GiacenzaMassima)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Azioni Consigliate */}
                                        {selectedProdotto.AzioneConsigliata && (
                                            <div className={`material-card-elevated rounded-lg p-6 ${
                                                selectedProdotto.Stato === "Critico" ? "bg-red-50" :
                                                selectedProdotto.Stato === "Attenzione" ? "bg-amber-50" :
                                                selectedProdotto.Stato === "Eccesso" ? "bg-blue-50" : "bg-green-50"
                                            }`}>
                                                <h3 className="text-lg font-medium text-gray-900 mb-2 flex items-center gap-2">
                                                    <svg className={`w-5 h-5 ${
                                                        selectedProdotto.Stato === "Critico" ? "text-red-600" :
                                                        selectedProdotto.Stato === "Attenzione" ? "text-amber-600" :
                                                        selectedProdotto.Stato === "Eccesso" ? "text-blue-600" : "text-green-600"
                                                    }`} fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                                    </svg>
                                                    Azione Consigliata
                                                </h3>
                                                <p className="text-sm text-gray-700">{selectedProdotto.AzioneConsigliata}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <div className="material-card bg-white rounded-lg p-4 flex items-center gap-3 text-sm text-gray-600">
                        <svg className="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/>
                        </svg>
                        <div>
                            <span className="font-medium">Dati caricati da:</span> {new URLSearchParams(window.location.search).get('data') || 'Magazzino.json'}
                            <span className="mx-2">·</span>
                            <span className="text-gray-500">Parametri: ?data=file.json&pdf=analisi.pdf&mp3=audio.mp3</span>
                        </div>
                    </div>
                </div>
                </div>
            );
        }

        // Mount
        function App() { return <MagazzinoDashboard />; }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>

<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Drilldown (demo)</title>
    <!-- Tailwind via CDN (ok per demo; avviso in console è normale) -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <!-- React 18 CDN + Babel per compilare JSX al volo (solo per demo) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- App: versione JS-only (senza import/export/TypeScript) -->
    <script type="text/babel" data-presets="env,react">
        const { useMemo, useState } = React;

        // Dati mock
        const SUMMARY = {
            date: "30/06/2025",
            currency: "EUR",
            totals: { gross: 12500000, allowance: 750000, net: 11750000, overdue: 6300000, overduePct: 50.4, dso: 68 },
            aging: [
                { bucket: "Non scaduto", value: 0 },
                { bucket: "0–30 gg", value: 6200000 },
                { bucket: "31–60 gg", value: 3100000 },
                { bucket: "61–90 gg", value: 2000000 },
                { bucket: ">90 gg", value: 1200000 },
            ],
        };

        const CLIENTS = [
            { name: "Cliente X", total: 2000000, gt90: 250000 },
            { name: "Cliente Y", total: 1200000, gt90: 180000 },
            { name: "Cliente Z", total: 900000, gt90: 90000 },
            { name: "Cliente A", total: 800000, gt90: 40000 },
            { name: "Cliente B", total: 700000, gt90: 0 },
            { name: "Cliente C", total: 600000, gt90: 60000 },
            { name: "Cliente D", total: 500000, gt90: 0 },
            { name: "Cliente E", total: 450000, gt90: 0 },
            { name: "Cliente F", total: 400000, gt90: 0 },
            { name: "Cliente G", total: 350000, gt90: 0 },
        ];

        const INVOICES = {
            "Cliente X": [
                { docType: "FT", docNo: "2025/001", docDate: "27/01/2025", dueDate: "05/03/2025", residual: 500000, bucket: "31–60 gg" },
                { docType: "FT", docNo: "2025/034", docDate: "27/01/2025", dueDate: "30/04/2025", residual: 800000, bucket: "61–90 gg" },
                { docType: "FT", docNo: "2025/322", docDate: "02/07/2025", dueDate: "30/09/2025", residual: 450000, bucket: "Non scaduto" },
                { docType: "FT", docNo: "2025/199", docDate: "11/03/2025", dueDate: "31/03/2025", residual: 250000, bucket: ">90 gg" },
            ],
            "Cliente Y": [
                { docType: "FT", docNo: "2025/105", docDate: "15/04/2025", dueDate: "30/04/2025", residual: 400000, bucket: "31–60 gg" },
                { docType: "FT", docNo: "2025/267", docDate: "16/05/2025", dueDate: "03/07/2025", residual: 620000, bucket: "61–90 gg" },
                { docType: "FT", docNo: "2025/177", docDate: "11/03/2025", dueDate: "31/03/2025", residual: 180000, bucket: ">90 gg" },
            ],
            "Cliente Z": [
                { docType: "FT", docNo: "2025/201", docDate: "27/02/2025", dueDate: "27/04/2025", residual: 300000, bucket: "61–90 gg" },
                { docType: "FT", docNo: "2025/202", docDate: "27/02/2025", dueDate: "27/05/2025", residual: 510000, bucket: "31–60 gg" },
                { docType: "FT", docNo: "2025/203", docDate: "27/02/2025", dueDate: "27/06/2025", residual: 90000, bucket: ">90 gg" },
            ],
        };

        const BUCKETS = ["Tutti", "Non scaduto", "0–30 gg", "31–60 gg", "61–90 gg", ">90 gg"];

        function numberFmt(val) { return val.toLocaleString("it-IT", { style: "currency", currency: "EUR", maximumFractionDigits: 0 }); }
        function pctFmt(val) { return `${val.toFixed(1)}%`; }

        // Smoke test minimi (test-case base)
        (function tests() {
            console.assert(BUCKETS.includes(">90 gg"), "Test: manca bucket >90 gg");
            console.assert((INVOICES["Cliente X"] || []).filter(i => i.bucket === ">90 gg").length === 1, "Test: Cliente X dovrebbe avere 1 fattura >90 gg");
        })();

        function ARDrilldownDashboard() {
            const [selectedBucket, setSelectedBucket] = useState("Tutti");
            const [selectedClient, setSelectedClient] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);

            const filteredClients = useMemo(() => {
                if (selectedBucket === "Tutti") return CLIENTS;
                return CLIENTS.filter((c) => (INVOICES[c.name] || []).some((i) => i.bucket === selectedBucket));
            }, [selectedBucket]);

            const kpi = useMemo(() => {
                const total = SUMMARY.totals.net;
                const overdue = SUMMARY.totals.overdue;
                const agingMap = Object.fromEntries(SUMMARY.aging.map(a => [a.bucket, a.value]));
                const bucketValue = selectedBucket === "Tutti" ? overdue : (agingMap[selectedBucket] || 0);
                const bucketPct = total > 0 ? (bucketValue / total) * 100 : 0;
                return { total, overdue, bucketValue, bucketPct };
            }, [selectedBucket]);

            const openClient = (name) => { setSelectedClient(name); setDrawerOpen(true); };

            const currentInvoices = useMemo(() => {
                const all = (selectedClient && INVOICES[selectedClient]) || [];
                return selectedBucket === "Tutti" ? all : all.filter(i => i.bucket === selectedBucket);
            }, [selectedClient, selectedBucket]);

            const totalAging = SUMMARY.aging.reduce((s, a) => s + a.value, 0) || 1;

            return (
                <div className="w-full p-6 space-y-6">
                    <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h1 className="text-2xl font-semibold">Scadenzario AR — Panoramica</h1>
                            <p className="text-sm text-gray-600">Data riferimento: {SUMMARY.date} · Valuta: {SUMMARY.currency}</p>
                            <div className="mt-2 text-sm text-gray-700">
                                <span className="font-medium">Percorso:</span>{" "}
                                <span>
                                    Panoramica
                                    {selectedBucket !== "Tutti" && <> → <span className="font-medium">{selectedBucket}</span></>}
                                    {selectedClient && <> → <span className="font-medium">{selectedClient}</span></>}
                                </span>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {BUCKETS.map((b) => (
                                <button key={b} onClick={() => setSelectedBucket(b)}
                                    className={`px-3 py-1 rounded-full border text-sm transition ${selectedBucket === b ? "bg-black text-white" : "bg-white hover:bg-gray-100"}`}>
                                    {b}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">Crediti netti</div>
                            <div className="text-2xl font-semibold">{numberFmt(kpi.total)}</div>
                            <div className="mt-2 text-xs text-gray-500">Lordi {numberFmt(SUMMARY.totals.gross)} · Fondo {numberFmt(SUMMARY.totals.allowance)}</div>
                        </div>
                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">Scaduto totale</div>
                            <div className="text-2xl font-semibold">{numberFmt(kpi.overdue)}</div>
                            <div className="mt-2 text-xs text-gray-500">{pctFmt(SUMMARY.totals.overduePct)} del totale</div>
                        </div>
                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">DSO (doc.)</div>
                            <div className="text-2xl font-semibold">{SUMMARY.totals.dso} giorni</div>
                            <div className="mt-2 text-xs text-gray-500">Metodo: crediti medi / vendite giornaliere × 365</div>
                        </div>
                    </div>

                    <div className="rounded-2xl border p-4 shadow-sm bg-white">
                        <div className="flex items-center justify-between mb-3">
                            <div className="font-medium">Distribuzione per aging</div>
                            <div className="text-sm text-gray-500">Click su una sezione per filtrare</div>
                        </div>
                        <div className="flex w-full h-8 overflow-hidden rounded-lg border">
                            {SUMMARY.aging.map((a) => {
                                const w = (a.value / totalAging) * 100;
                                const active = selectedBucket === a.bucket;
                                return (
                                    <button key={a.bucket} title={`${a.bucket} — ${numberFmt(a.value)}`}
                                        onClick={() => setSelectedBucket(a.bucket)}
                                        style={{ width: `${w}%` }}
                                        className={`h-full text-[10px] md:text-xs flex items-center justify-center border-r last:border-r-0 transition ${active ? "bg-black text-white" : "bg-gray-100 hover:bg-gray-200"}`}>
                                        <div className="px-1 truncate">{a.bucket}</div>
                                    </button>
                                );
                            })}
                        </div>
                        <div className="mt-3 text-sm text-gray-700">
                            <span className="font-medium">Quota selezionata: </span>
                            {numberFmt(kpi.bucketValue)} ({pctFmt(kpi.bucketPct)}) su crediti netti
                        </div>
                    </div>

                    <div className="rounded-2xl border p-4 shadow-sm bg-white">
                        <div className="flex items-center justify-between mb-3">
                            <div className="font-medium">Top clienti</div>
                            <div className="text-sm text-gray-500">Click su una riga per il drill-down</div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="text-left text-gray-500 border-b">
                                        <th className="py-2 pr-4">Cliente</th>
                                        <th className="py-2 pr-4">Esposizione</th>
                                        <th className="py-2 pr-4">Quota su totale</th>
                                        <th className="py-2 pr-4">{"Quota >90 gg"}</th>
                                        <th className="py-2"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredClients.map((c, idx) => {
                                        const pct = (c.total / SUMMARY.totals.net) * 100;
                                        const gt90pct = c.total ? (c.gt90 / c.total) * 100 : 0;
                                        return (
                                            <tr key={c.name} className="border-b hover:bg-gray-50 cursor-pointer" onClick={() => { setSelectedClient(c.name); setDrawerOpen(true); }}>
                                                <td className="py-2 pr-4"><div className="font-medium">{idx + 1}. {c.name}</div></td>
                                                <td className="py-2 pr-4">{numberFmt(c.total)}</td>
                                                <td className="py-2 pr-4">{pctFmt(pct)}</td>
                                                <td className="py-2 pr-4">{pctFmt(gt90pct)}</td>
                                                <td className="py-2 text-right"><span className="text-xs text-blue-600 underline">Dettagli</span></td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    { /* Drawer */}
                    {drawerOpen && (
                        <div className="fixed inset-0 z-40">
                            <div className="absolute inset-0 bg-black/30" onClick={() => setDrawerOpen(false)} />
                            <div className="absolute right-0 top-0 h-full w-full sm:w-[520px] bg-white shadow-2xl p-6 overflow-y-auto">
                                <div className="flex items-start justify-between gap-4">
                                    <div>
                                        <div className="text-xs text-gray-500">Dettaglio</div>
                                        <h2 className="text-xl font-semibold">{selectedClient} {selectedBucket !== "Tutti" && `— ${selectedBucket}`}</h2>
                                    </div>
                                    <button className="text-sm px-3 py-1 rounded-md border hover:bg-gray-50" onClick={() => setDrawerOpen(false)}>Chiudi</button>
                                </div>

                                <div className="mt-4 flex flex-wrap gap-2">
                                    {BUCKETS.map((b) => (
                                        <button key={b} onClick={() => setSelectedBucket(b)}
                                            className={`px-3 py-1 rounded-full border text-sm transition ${selectedBucket === b ? "bg-black text-white" : "bg-white hover:bg-gray-100"}`}>
                                            {b}
                                        </button>
                                    ))}
                                </div>

                                <div className="mt-4">
                                    <div className="text-sm font-medium mb-2">Fatture ({(selectedClient && (INVOICES[selectedClient] || []).filter(i => selectedBucket === "Tutti" || i.bucket === selectedBucket).length) || 0})</div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="text-left text-gray-500 border-b">
                                                    <th className="py-2 pr-3">Tipo</th>
                                                    <th className="py-2 pr-3">N. Doc</th>
                                                    <th className="py-2 pr-3">Data Doc</th>
                                                    <th className="py-2 pr-3">Scadenza</th>
                                                    <th className="py-2 pr-3">Residuo</th>
                                                    <th className="py-2 pr-3">Bucket</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {((selectedClient && (INVOICES[selectedClient] || [])) || [])
                                                    .filter(i => selectedBucket === "Tutti" || i.bucket === selectedBucket)
                                                    .map((i, idx) => (
                                                        <tr key={idx} className="border-b last:border-b-0">
                                                            <td className="py-2 pr-3">{i.docType}</td>
                                                            <td className="py-2 pr-3">{i.docNo}</td>
                                                            <td className="py-2 pr-3">{i.docDate}</td>
                                                            <td className="py-2 pr-3">{i.dueDate}</td>
                                                            <td className="py-2 pr-3">{numberFmt(i.residual)}</td>
                                                            <td className="py-2 pr-3">{i.bucket}</td>
                                                        </tr>
                                                    ))}
                                                {(!selectedClient || ((INVOICES[selectedClient] || []).filter(i => selectedBucket === "Tutti" || i.bucket === selectedBucket).length === 0)) && (
                                                    <tr><td colSpan="6" className="py-6 text-center text-gray-500">Nessuna fattura per il filtro selezionato.</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="mt-6 rounded-xl border p-4 bg-gray-50">
                                    <div className="text-sm font-medium mb-1">Spiegazione (LLM) del drill-down selezionato</div>
                                    <p className="text-xs text-gray-600">Quando l'utente apre questo pannello, invia al modello le righe filtrate come <em>contesto</em> + un prompt breve.</p>
                                    <pre className="mt-3 text-xs whitespace-pre-wrap leading-5 bg-white p-3 rounded-md border overflow-x-auto">
                                        {`Prompt (esempio):
Sei un credit/AR analyst. Spiega in 120–180 parole il dettaglio selezionato, citando le fonti come "riga X".
Contesto: fatture di ${'${selectedClient || "<cliente>"}'} nel bucket ${'${selectedBucket}'} al ${'${SUMMARY.date}'}, valuta EUR.
Obiettivi: indica importi rilevanti, incidenze %, e rischi/azioni (contenziosi, promesse di pagamento, dilazioni se note).`}
                                    </pre>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="text-xs text-gray-500">Suggerimento: collega i click a query Qdrant filtrate e calcoli lato server.</div>
                </div>
            );
        }

        // Mount
        function App() { return <ARDrilldownDashboard />; }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>
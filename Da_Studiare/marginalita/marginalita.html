<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Marginalità</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2pdf.js per export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Roboto', sans-serif; }
        .material-card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        .material-card:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            transform: translateY(-2px);
        }
        .material-card-elevated {
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:active::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: ripple-animation 0.6s ease-out;
        }
        @keyframes ripple-animation {
            to { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    </style>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react">
        const { useMemo, useState, useEffect } = React;

        // Variabili globali per i dati
        let PERIODO = "";
        let PRODOTTI = [];
        let CLIENTI = [];
        let AREE_GEOGRAFICHE = [];
        let PDF_ANALISI = "";
        let MP3_ANALISI = "";

        function numberFmt(val) {
            return val.toLocaleString("it-IT", {
                style: "currency",
                currency: "EUR",
                maximumFractionDigits: 0
            });
        }

        function pctFmt(val) { return `${val.toFixed(1)}%`; }

        // Funzione per esportare in PDF
        function exportToPDF() {
            const element = document.getElementById('dashboard-content');
            const opt = {
                margin: 10,
                filename: `Dashboard_Marginalita_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function calcVariance(actual, target) {
            if (!target) return 0;
            return ((actual - target) / target) * 100;
        }

        const DIMENSION_COLORS = {
            "Prodotti": "bg-blue-50",
            "Clienti": "bg-emerald-50",
            "Aree Geografiche": "bg-purple-50"
        };

        const DIMENSION_ICON_COLORS = {
            "Prodotti": "text-blue-600",
            "Clienti": "text-emerald-600",
            "Aree Geografiche": "text-purple-600"
        };

        const DIMENSION_ICONS = {
            "Prodotti": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"/></svg>,
            "Clienti": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>,
            "Aree Geografiche": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        };

        function MarginalitaDashboard() {
            const [selectedDimension, setSelectedDimension] = useState("Prodotti");
            const [selectedItem, setSelectedItem] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);

            // Carica dati dal JSON
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const dataFile = urlParams.get('data') || 'marginalita.json';
                PDF_ANALISI = urlParams.get('pdf') || '';
                MP3_ANALISI = urlParams.get('mp3') || '';

                console.log(`Caricamento dati da: ${dataFile}`);
                console.log(`PDF Analisi: ${PDF_ANALISI || 'Non specificato'}`);
                console.log(`MP3 Analisi: ${MP3_ANALISI || 'Non specificato'}`);

                fetch(dataFile)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - File non trovato: ${dataFile}`);
                        }
                        return response.json();
                    })
                    .then(jsonData => {
                        PERIODO = jsonData.Periodo;
                        PRODOTTI = jsonData.Prodotti;
                        CLIENTI = jsonData.Clienti;
                        AREE_GEOGRAFICHE = jsonData.AreeGeografiche;
                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Errore caricamento dati:', err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            const kpiSummary = useMemo(() => {
                if (!data) return null;

                const totRicavi = PRODOTTI.reduce((sum, p) => sum + p.Ricavi, 0);
                const totCosti = PRODOTTI.reduce((sum, p) => sum + p.Costi, 0);
                const totMargine = totRicavi - totCosti;
                const marginePct = totRicavi > 0 ? (totMargine / totRicavi) * 100 : 0;

                const topProdotto = [...PRODOTTI].sort((a, b) => (b.Ricavi - b.Costi) - (a.Ricavi - a.Costi))[0];
                const topCliente = [...CLIENTI].sort((a, b) => (b.Ricavi - b.Costi) - (a.Ricavi - a.Costi))[0];

                return {
                    totRicavi,
                    totCosti,
                    totMargine,
                    marginePct,
                    topProdotto,
                    topCliente
                };
            }, [data]);

            const currentData = useMemo(() => {
                if (!data) return [];
                if (selectedDimension === "Prodotti") return PRODOTTI;
                if (selectedDimension === "Clienti") return CLIENTI;
                return AREE_GEOGRAFICHE;
            }, [selectedDimension, data]);

            if (loading) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
                            <div className="text-xl font-medium text-gray-700">Caricamento dati marginalità...</div>
                            <div className="text-sm text-gray-500 mt-2">Attendere prego</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center max-w-md material-card-elevated bg-white rounded-lg p-8">
                            <svg className="w-16 h-16 text-red-500 mx-auto mb-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <div className="text-xl font-medium mb-3 text-red-600">Errore caricamento dati</div>
                            <div className="text-gray-700 mb-4">{error}</div>
                            <div className="text-sm text-gray-500">Assicurati che il file JSON sia presente nella directory.</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full min-h-screen bg-gray-50">
                    {/* Material Design AppBar */}
                    <div className="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white shadow-lg">
                        <div className="max-w-7xl mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2.5 2.1h-15V5h15v14.1zm0-16.1h-15c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                                    </svg>
                                    <div>
                                        <h1 className="text-xl font-medium">Dashboard Marginalità / Profittabilità</h1>
                                        <p className="text-sm text-indigo-100">Periodo: {PERIODO} · Valuta: EUR</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={exportToPDF}
                                        className="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white rounded-lg transition-all hover:shadow-lg"
                                        title="Esporta dashboard in PDF"
                                    >
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                                        </svg>
                                        <span className="font-medium">Esporta PDF</span>
                                    </button>
                                    <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded text-sm font-medium">Per Prodotto</div>
                                    <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded text-sm font-medium">Per Cliente</div>
                                    <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded text-sm font-medium">Per Area</div>
                                </div>
                            </div>
                            {selectedDimension && (
                                <div className="mt-3 flex items-center gap-2 text-sm text-indigo-100">
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                    </svg>
                                    <span>Panoramica</span>
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                    </svg>
                                    <span className="font-medium text-white">{selectedDimension}</span>
                                </div>
                            )}
                        </div>
                    </div>

                    <div id="dashboard-content" className="max-w-7xl mx-auto p-6 space-y-6">

                    {/* Sezione Analisi - Mostrata solo se c'è almeno un file */}
                    {(PDF_ANALISI || MP3_ANALISI) && (
                        <div className="material-card bg-white rounded-lg p-6">
                            <div className="flex items-center gap-3 mb-4">
                                <svg className="w-6 h-6 text-indigo-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                                </svg>
                                <h2 className="text-xl font-medium text-gray-900">Analisi</h2>
                            </div>
                            <div className={`grid grid-cols-1 ${PDF_ANALISI && MP3_ANALISI ? 'md:grid-cols-2' : ''} gap-4`}>
                                {/* PDF Link */}
                                {PDF_ANALISI && (
                                    <a
                                        href={PDF_ANALISI}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="flex items-center gap-3 p-4 bg-gradient-to-r from-red-50 to-red-100 rounded-lg hover:from-red-100 hover:to-red-200 transition-all ripple group"
                                    >
                                        <div className="bg-red-600 text-white p-3 rounded-lg group-hover:scale-110 transition-transform">
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/>
                                            </svg>
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900">Analisi Riassuntiva (PDF)</div>
                                            <div className="text-sm text-gray-600">Rapporto completo marginalità</div>
                                        </div>
                                        <svg className="w-5 h-5 text-red-600 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                        </svg>
                                    </a>
                                )}

                                {/* MP3 Link */}
                                {MP3_ANALISI && (
                                    <a
                                        href={MP3_ANALISI}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="flex items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg hover:from-purple-100 hover:to-purple-200 transition-all ripple group"
                                    >
                                        <div className="bg-purple-600 text-white p-3 rounded-lg group-hover:scale-110 transition-transform">
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
                                            </svg>
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900">Podcast Analisi (MP3)</div>
                                            <div className="text-sm text-gray-600">Commento audio marginalità</div>
                                        </div>
                                        <svg className="w-5 h-5 text-purple-600 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                        </svg>
                                    </a>
                                )}
                            </div>
                        </div>
                    )}

                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-emerald-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Ricavi Totali</div>
                                <svg className="w-6 h-6 text-emerald-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{numberFmt(kpiSummary.totRicavi)}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                Su tutti i prodotti/clienti
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-rose-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Costi Totali</div>
                                <svg className="w-6 h-6 text-rose-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-6v11c0 1.1-.9 2-2 2H4v-2h17V7h2z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{numberFmt(kpiSummary.totCosti)}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                Costi diretti e indiretti
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-blue-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Margine Totale</div>
                                <svg className="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                                </svg>
                            </div>
                            <div className={`text-3xl font-bold ${kpiSummary.totMargine >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {numberFmt(kpiSummary.totMargine)}
                            </div>
                            <div className="mt-3 text-sm text-gray-500">
                                Ricavi - Costi
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-purple-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Margine %</div>
                                <svg className="w-6 h-6 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2.5 2.1h-15V5h15v14.1zm0-16.1h-15c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{pctFmt(kpiSummary.marginePct)}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                Margine / Ricavi
                            </div>
                        </div>
                    </div>

                    {/* Filtri Dimensione */}
                    <div className="material-card bg-white rounded-lg p-4">
                        <div className="flex flex-wrap gap-2">
                            {["Prodotti", "Clienti", "Aree Geografiche"].map((dim) => {
                                const isActive = selectedDimension === dim;
                                return (
                                    <button key={dim} onClick={() => setSelectedDimension(dim)}
                                        className={`ripple px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${isActive ? "bg-indigo-600 text-white shadow-lg" : "bg-gray-100 text-gray-800 hover:bg-gray-200"}`}>
                                        {dim}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* Top Performers */}
                    <div className="material-card bg-white rounded-lg p-6">
                        <div className="flex items-center gap-3 mb-4">
                            <svg className="w-6 h-6 text-indigo-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <h2 className="text-xl font-medium text-gray-900">Analisi per {selectedDimension}</h2>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50">
                                    <tr className="text-left border-b-2 border-indigo-500">
                                        <th className="py-4 px-4 font-medium text-gray-700 uppercase text-xs tracking-wide">Nome</th>
                                        <th className="py-4 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Ricavi</th>
                                        <th className="py-4 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Costi</th>
                                        <th className="py-4 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Margine</th>
                                        <th className="py-4 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Margine %</th>
                                        <th className="py-4 px-4"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {currentData.map((item, idx) => {
                                        const margine = item.Ricavi - item.Costi;
                                        const marginePct = item.Ricavi > 0 ? (margine / item.Ricavi) * 100 : 0;
                                        const getMargineColor = (pct) => {
                                            if (pct >= 40) return "text-green-600";
                                            if (pct >= 20) return "text-blue-600";
                                            if (pct >= 10) return "text-amber-600";
                                            return "text-red-600";
                                        };
                                        return (
                                            <tr key={idx} className="border-b border-gray-100 hover:bg-indigo-50 cursor-pointer transition-colors"
                                                onClick={() => { setSelectedItem(item); setDrawerOpen(true); }}>
                                                <td className="py-3 px-4 font-medium text-gray-900">{item.Nome}</td>
                                                <td className="py-3 px-4 text-right text-gray-900 font-semibold">{numberFmt(item.Ricavi)}</td>
                                                <td className="py-3 px-4 text-right text-gray-600">{numberFmt(item.Costi)}</td>
                                                <td className={`py-3 px-4 text-right font-bold ${margine >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {numberFmt(margine)}
                                                </td>
                                                <td className={`py-3 px-4 text-right font-bold ${getMargineColor(marginePct)}`}>
                                                    {pctFmt(marginePct)}
                                                </td>
                                                <td className="py-3 px-4 text-right">
                                                    <svg className="w-5 h-5 text-indigo-600 inline-block" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                                    </svg>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Material Bottom Sheet */}
                    {drawerOpen && selectedItem && (
                        <div className="fixed inset-0 z-50 animate-fadeIn">
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={() => setDrawerOpen(false)} />
                            <div className="absolute bottom-0 left-0 w-full h-[75vh] bg-white shadow-2xl overflow-hidden animate-slideUp">
                                <div className="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-6 py-5 shadow-md">
                                    <div className="flex items-start justify-between gap-4">
                                        <div className="flex items-center gap-3">
                                            <div className="text-white">
                                                {DIMENSION_ICONS[selectedDimension]}
                                            </div>
                                            <div>
                                                <div className="text-xs text-indigo-100 uppercase tracking-wide">Dettaglio {selectedDimension}</div>
                                                <h2 className="text-2xl font-medium mt-1">{selectedItem.Nome}</h2>
                                                <p className="text-sm text-indigo-100 mt-1">Periodo: {PERIODO}</p>
                                            </div>
                                        </div>
                                        <button
                                            className="ripple bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all"
                                            onClick={() => setDrawerOpen(false)}
                                        >
                                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                            </svg>
                                            <span className="font-medium">Chiudi</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="p-6 overflow-y-auto h-[calc(100%-100px)]">
                                    <div className="material-card-elevated rounded-lg overflow-hidden bg-white">
                                        <div className="p-6 space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-emerald-50 p-4 rounded-lg">
                                                    <div className="text-sm text-gray-600 mb-2">Ricavi</div>
                                                    <div className="text-2xl font-bold text-emerald-600">{numberFmt(selectedItem.Ricavi)}</div>
                                                </div>
                                                <div className="bg-rose-50 p-4 rounded-lg">
                                                    <div className="text-sm text-gray-600 mb-2">Costi</div>
                                                    <div className="text-2xl font-bold text-rose-600">{numberFmt(selectedItem.Costi)}</div>
                                                </div>
                                                <div className="bg-blue-50 p-4 rounded-lg">
                                                    <div className="text-sm text-gray-600 mb-2">Margine</div>
                                                    <div className={`text-2xl font-bold ${(selectedItem.Ricavi - selectedItem.Costi) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                        {numberFmt(selectedItem.Ricavi - selectedItem.Costi)}
                                                    </div>
                                                </div>
                                                <div className="bg-purple-50 p-4 rounded-lg">
                                                    <div className="text-sm text-gray-600 mb-2">Margine %</div>
                                                    <div className="text-2xl font-bold text-purple-600">
                                                        {pctFmt(selectedItem.Ricavi > 0 ? ((selectedItem.Ricavi - selectedItem.Costi) / selectedItem.Ricavi) * 100 : 0)}
                                                    </div>
                                                </div>
                                            </div>

                                            {selectedItem.Dettaglio && (
                                                <div className="mt-6">
                                                    <h3 className="text-lg font-medium text-gray-900 mb-3">Dettaglio Costi</h3>
                                                    <div className="space-y-2">
                                                        {Object.entries(selectedItem.Dettaglio).map(([voce, valore]) => (
                                                            <div key={voce} className="flex items-center justify-between py-2 px-4 bg-gray-50 rounded">
                                                                <span className="text-sm text-gray-700">{voce}</span>
                                                                <span className="text-sm font-medium text-gray-900">{numberFmt(valore)}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <div className="material-card bg-white rounded-lg p-4 flex items-center gap-3 text-sm text-gray-600">
                        <svg className="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/>
                        </svg>
                        <div>
                            <span className="font-medium">Dati caricati da:</span> {new URLSearchParams(window.location.search).get('data') || 'marginalita.json'}
                            <span className="mx-2">·</span>
                            <span className="text-gray-500">Parametri: ?data=file.json&pdf=analisi.pdf&mp3=audio.mp3</span>
                        </div>
                    </div>
                </div>
                </div>
            );
        }

        // Mount
        function App() { return <MarginalitaDashboard />; }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>

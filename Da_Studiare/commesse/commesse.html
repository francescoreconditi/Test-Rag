<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Avanzamento Commesse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Roboto', sans-serif; }
        .material-card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        .material-card:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            transform: translateY(-2px);
        }
        .material-card-elevated {
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:active::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: ripple-animation 0.6s ease-out;
        }
        @keyframes ripple-animation {
            to { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    </style>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react">
        const { useMemo, useState, useEffect } = React;

        // Variabili globali per i dati
        let PERIODO = "";
        let COMMESSE = [];
        let PDF_ANALISI = "";
        let MP3_ANALISI = "";

        function numberFmt(val) {
            return val.toLocaleString("it-IT", {
                style: "currency",
                currency: "EUR",
                maximumFractionDigits: 0
            });
        }

        function pctFmt(val) { return `${val.toFixed(1)}%`; }

        function calcVariance(actual, target) {
            if (!target) return 0;
            return ((actual - target) / target) * 100;
        }

        const STATUS_COLORS = {
            "In Corso": "bg-blue-100 text-blue-800",
            "In Ritardo": "bg-red-100 text-red-800",
            "Completata": "bg-green-100 text-green-800",
            "In Pausa": "bg-amber-100 text-amber-800"
        };

        const STATUS_ICONS = {
            "In Corso": <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>,
            "In Ritardo": <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>,
            "Completata": <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>,
            "In Pausa": <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        };

        function CommesseDashboard() {
            const [selectedStatus, setSelectedStatus] = useState("Tutti");
            const [selectedCommessa, setSelectedCommessa] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);

            // Carica dati dal JSON
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const dataFile = urlParams.get('data') || 'commesse.json';
                PDF_ANALISI = urlParams.get('pdf') || '';
                MP3_ANALISI = urlParams.get('mp3') || '';

                console.log(`Caricamento dati da: ${dataFile}`);
                console.log(`PDF Analisi: ${PDF_ANALISI || 'Non specificato'}`);
                console.log(`MP3 Analisi: ${MP3_ANALISI || 'Non specificato'}`);

                fetch(dataFile)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - File non trovato: ${dataFile}`);
                        }
                        return response.json();
                    })
                    .then(jsonData => {
                        PERIODO = jsonData.Periodo;
                        COMMESSE = jsonData.Commesse;
                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Errore caricamento dati:', err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            const kpiSummary = useMemo(() => {
                if (!data) return null;

                const totCommesse = COMMESSE.length;
                const totValore = COMMESSE.reduce((sum, c) => sum + c.ValoreTotale, 0);
                const totFatturato = COMMESSE.reduce((sum, c) => sum + c.Fatturato, 0);
                const totCosti = COMMESSE.reduce((sum, c) => sum + c.CostiSostenuti, 0);
                const totMargine = totFatturato - totCosti;
                const avgAvanzamento = COMMESSE.reduce((sum, c) => sum + c.AvanzamentoPerc, 0) / totCommesse;

                const inCorso = COMMESSE.filter(c => c.Stato === "In Corso").length;
                const inRitardo = COMMESSE.filter(c => c.Stato === "In Ritardo").length;
                const completate = COMMESSE.filter(c => c.Stato === "Completata").length;

                return {
                    totCommesse,
                    totValore,
                    totFatturato,
                    totCosti,
                    totMargine,
                    avgAvanzamento,
                    inCorso,
                    inRitardo,
                    completate
                };
            }, [data]);

            const filteredCommesse = useMemo(() => {
                if (!data) return [];
                if (selectedStatus === "Tutti") return COMMESSE;
                return COMMESSE.filter(c => c.Stato === selectedStatus);
            }, [selectedStatus, data]);

            if (loading) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
                            <div className="text-xl font-medium text-gray-700">Caricamento dati commesse...</div>
                            <div className="text-sm text-gray-500 mt-2">Attendere prego</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center max-w-md material-card-elevated bg-white rounded-lg p-8">
                            <svg className="w-16 h-16 text-red-500 mx-auto mb-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <div className="text-xl font-medium mb-3 text-red-600">Errore caricamento dati</div>
                            <div className="text-gray-700 mb-4">{error}</div>
                            <div className="text-sm text-gray-500">Assicurati che il file JSON sia presente nella directory.</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full min-h-screen bg-gray-50">
                    {/* Material Design AppBar */}
                    <div className="bg-gradient-to-r from-teal-600 to-teal-700 text-white shadow-lg">
                        <div className="max-w-7xl mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                    </svg>
                                    <div>
                                        <h1 className="text-xl font-medium">Dashboard Avanzamento Commesse / Progetti</h1>
                                        <p className="text-sm text-teal-100">Periodo: {PERIODO} ¬∑ Valuta: EUR</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded text-sm font-medium">
                                        {kpiSummary.totCommesse} Progetti Attivi
                                    </div>
                                </div>
                            </div>
                            {selectedStatus !== "Tutti" && (
                                <div className="mt-3 flex items-center gap-2 text-sm text-teal-100">
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                    </svg>
                                    <span>Panoramica</span>
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                    </svg>
                                    <span className="font-medium text-white">Filtro: {selectedStatus}</span>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-6 space-y-6">

                    {/* Sezione Analisi - Mostrata solo se c'√® almeno un file */}
                    {(PDF_ANALISI || MP3_ANALISI) && (
                        <div className="material-card bg-white rounded-lg p-6">
                            <div className="flex items-center gap-3 mb-4">
                                <svg className="w-6 h-6 text-teal-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                                </svg>
                                <h2 className="text-xl font-medium text-gray-900">Analisi</h2>
                            </div>
                            <div className={`grid grid-cols-1 ${PDF_ANALISI && MP3_ANALISI ? 'md:grid-cols-2' : ''} gap-4`}>
                                {/* PDF Link */}
                                {PDF_ANALISI && (
                                    <a
                                        href={PDF_ANALISI}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="flex items-center gap-3 p-4 bg-gradient-to-r from-red-50 to-red-100 rounded-lg hover:from-red-100 hover:to-red-200 transition-all ripple group"
                                    >
                                        <div className="bg-red-600 text-white p-3 rounded-lg group-hover:scale-110 transition-transform">
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/>
                                            </svg>
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900">Analisi Riassuntiva (PDF)</div>
                                            <div className="text-sm text-gray-600">Rapporto completo avanzamento commesse</div>
                                        </div>
                                        <svg className="w-5 h-5 text-red-600 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                        </svg>
                                    </a>
                                )}

                                {/* MP3 Link */}
                                {MP3_ANALISI && (
                                    <a
                                        href={MP3_ANALISI}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="flex items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg hover:from-purple-100 hover:to-purple-200 transition-all ripple group"
                                    >
                                        <div className="bg-purple-600 text-white p-3 rounded-lg group-hover:scale-110 transition-transform">
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
                                            </svg>
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900">Podcast Analisi (MP3)</div>
                                            <div className="text-sm text-gray-600">Commento audio stato commesse</div>
                                        </div>
                                        <svg className="w-5 h-5 text-purple-600 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                        </svg>
                                    </a>
                                )}
                            </div>
                        </div>
                    )}

                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-teal-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Valore Totale</div>
                                <svg className="w-6 h-6 text-teal-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{numberFmt(kpiSummary.totValore)}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                {kpiSummary.totCommesse} commesse attive
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-emerald-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Fatturato</div>
                                <svg className="w-6 h-6 text-emerald-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{numberFmt(kpiSummary.totFatturato)}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                {pctFmt((kpiSummary.totFatturato / kpiSummary.totValore) * 100)} del valore
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-blue-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Margine</div>
                                <svg className="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                                </svg>
                            </div>
                            <div className={`text-3xl font-bold ${kpiSummary.totMargine >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {numberFmt(kpiSummary.totMargine)}
                            </div>
                            <div className="mt-3 text-sm text-gray-500">
                                Fatturato - Costi sostenuti
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-purple-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Avanzamento Medio</div>
                                <svg className="w-6 h-6 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{pctFmt(kpiSummary.avgAvanzamento)}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                Su tutte le commesse
                            </div>
                        </div>
                    </div>

                    {/* Filtri Status */}
                    <div className="material-card bg-white rounded-lg p-4">
                        <div className="flex flex-wrap gap-2">
                            {["Tutti", "In Corso", "In Ritardo", "Completata", "In Pausa"].map((status) => {
                                const isActive = selectedStatus === status;
                                const count = status === "Tutti" ? COMMESSE.length : COMMESSE.filter(c => c.Stato === status).length;
                                return (
                                    <button key={status} onClick={() => setSelectedStatus(status)}
                                        className={`ripple px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap flex items-center gap-2 ${isActive ? "bg-teal-600 text-white shadow-lg" : "bg-gray-100 text-gray-800 hover:bg-gray-200"}`}>
                                        {status !== "Tutti" && STATUS_ICONS[status]}
                                        {status} ({count})
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* Lista Commesse */}
                    <div className="material-card bg-white rounded-lg p-6">
                        <div className="flex items-center gap-3 mb-4">
                            <svg className="w-6 h-6 text-teal-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                            </svg>
                            <h2 className="text-xl font-medium text-gray-900">Commesse ({filteredCommesse.length})</h2>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            {filteredCommesse.map((commessa, idx) => {
                                const margine = commessa.Fatturato - commessa.CostiSostenuti;
                                const marginePct = commessa.Fatturato > 0 ? (margine / commessa.Fatturato) * 100 : 0;

                                return (
                                    <div key={idx}
                                        onClick={() => { setSelectedCommessa(commessa); setDrawerOpen(true); }}
                                        className="material-card bg-white rounded-lg p-5 cursor-pointer border-l-4 border-teal-500 hover:border-teal-600">
                                        <div className="flex items-start justify-between mb-3">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <h3 className="font-medium text-gray-900 text-lg">{commessa.Nome}</h3>
                                                    {commessa.Tipo === "Produzione" && (
                                                        <span className="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs font-medium rounded">
                                                            üè≠ Produzione
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="text-sm text-gray-600 mt-1">{commessa.Cliente}</div>
                                            </div>
                                            <span className={`px-3 py-1 rounded-lg text-xs font-medium ${STATUS_COLORS[commessa.Stato]}`}>
                                                {commessa.Stato}
                                            </span>
                                        </div>

                                        <div className="space-y-2 mb-4">
                                            <div className="flex items-center justify-between text-sm">
                                                <span className="text-gray-600">Valore Totale</span>
                                                <span className="font-medium text-gray-900">{numberFmt(commessa.ValoreTotale)}</span>
                                            </div>
                                            <div className="flex items-center justify-between text-sm">
                                                <span className="text-gray-600">Fatturato</span>
                                                <span className="font-medium text-emerald-600">{numberFmt(commessa.Fatturato)}</span>
                                            </div>
                                            <div className="flex items-center justify-between text-sm">
                                                <span className="text-gray-600">Margine</span>
                                                <span className={`font-medium ${margine >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {numberFmt(margine)} ({pctFmt(marginePct)})
                                                </span>
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            <div className="flex items-center justify-between text-xs text-gray-600">
                                                <span>Avanzamento</span>
                                                <span className="font-medium">{pctFmt(commessa.AvanzamentoPerc)}</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                                <div
                                                    className={`h-full rounded-full transition-all ${commessa.AvanzamentoPerc >= 80 ? 'bg-green-500' : commessa.AvanzamentoPerc >= 50 ? 'bg-blue-500' : 'bg-amber-500'}`}
                                                    style={{ width: `${commessa.AvanzamentoPerc}%` }}
                                                />
                                            </div>
                                        </div>

                                        <div className="mt-4 pt-3 border-t flex items-center justify-between text-xs text-gray-500">
                                            <div className="flex items-center gap-3">
                                                <span>Inizio: {commessa.DataInizio}</span>
                                                {commessa.Tipo === "Produzione" && commessa.Semilavorati && commessa.Semilavorati.length > 0 && (
                                                    <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded font-medium">
                                                        üè≠ {commessa.Semilavorati.length} Semilavorati
                                                    </span>
                                                )}
                                            </div>
                                            <span>Fine prevista: {commessa.DataFinePrevista}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Material Bottom Sheet */}
                    {drawerOpen && selectedCommessa && (
                        <div className="fixed inset-0 z-50 animate-fadeIn">
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={() => setDrawerOpen(false)} />
                            <div className="absolute bottom-0 left-0 w-full h-[80vh] bg-white shadow-2xl overflow-hidden animate-slideUp">
                                <div className="bg-gradient-to-r from-teal-600 to-teal-700 text-white px-6 py-5 shadow-md">
                                    <div className="flex items-start justify-between gap-4">
                                        <div className="flex-1">
                                            <div className="text-xs text-teal-100 uppercase tracking-wide">Dettaglio Commessa</div>
                                            <h2 className="text-2xl font-medium mt-1">{selectedCommessa.Nome}</h2>
                                            <p className="text-sm text-teal-100 mt-1">Cliente: {selectedCommessa.Cliente}</p>
                                            <div className="mt-2">
                                                <span className={`inline-block px-3 py-1 rounded-lg text-xs font-medium ${STATUS_COLORS[selectedCommessa.Stato]}`}>
                                                    {selectedCommessa.Stato}
                                                </span>
                                            </div>
                                        </div>
                                        <button
                                            className="ripple bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all"
                                            onClick={() => setDrawerOpen(false)}
                                        >
                                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                            </svg>
                                            <span className="font-medium">Chiudi</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="p-6 overflow-y-auto h-[calc(100%-140px)]">
                                    <div className="space-y-6">
                                        {/* KPI Commessa */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div className="bg-teal-50 p-4 rounded-lg">
                                                <div className="text-sm text-gray-600 mb-2">Valore Totale</div>
                                                <div className="text-2xl font-bold text-teal-600">{numberFmt(selectedCommessa.ValoreTotale)}</div>
                                            </div>
                                            <div className="bg-emerald-50 p-4 rounded-lg">
                                                <div className="text-sm text-gray-600 mb-2">Fatturato</div>
                                                <div className="text-2xl font-bold text-emerald-600">{numberFmt(selectedCommessa.Fatturato)}</div>
                                            </div>
                                            <div className="bg-rose-50 p-4 rounded-lg">
                                                <div className="text-sm text-gray-600 mb-2">Costi</div>
                                                <div className="text-2xl font-bold text-rose-600">{numberFmt(selectedCommessa.CostiSostenuti)}</div>
                                            </div>
                                            <div className="bg-blue-50 p-4 rounded-lg">
                                                <div className="text-sm text-gray-600 mb-2">Margine</div>
                                                <div className={`text-2xl font-bold ${(selectedCommessa.Fatturato - selectedCommessa.CostiSostenuti) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {numberFmt(selectedCommessa.Fatturato - selectedCommessa.CostiSostenuti)}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Avanzamento */}
                                        <div className="material-card-elevated rounded-lg p-6 bg-white">
                                            <h3 className="text-lg font-medium text-gray-900 mb-4">Avanzamento Progetto</h3>
                                            <div className="space-y-4">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-600">Percentuale completamento</span>
                                                    <span className="text-lg font-bold text-teal-600">{pctFmt(selectedCommessa.AvanzamentoPerc)}</span>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                                    <div
                                                        className="h-full rounded-full bg-gradient-to-r from-teal-500 to-teal-600 transition-all"
                                                        style={{ width: `${selectedCommessa.AvanzamentoPerc}%` }}
                                                    />
                                                </div>
                                                <div className="grid grid-cols-3 gap-4 mt-4">
                                                    <div className="text-center">
                                                        <div className="text-xs text-gray-500">Ore Previste</div>
                                                        <div className="text-lg font-medium text-gray-900">{selectedCommessa.OrePreviste}</div>
                                                    </div>
                                                    <div className="text-center">
                                                        <div className="text-xs text-gray-500">Ore Lavorate</div>
                                                        <div className="text-lg font-medium text-blue-600">{selectedCommessa.OreLavorate}</div>
                                                    </div>
                                                    <div className="text-center">
                                                        <div className="text-xs text-gray-500">Ore Rimanenti</div>
                                                        <div className="text-lg font-medium text-amber-600">{selectedCommessa.OrePreviste - selectedCommessa.OreLavorate}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Timeline */}
                                        <div className="material-card-elevated rounded-lg p-6 bg-white">
                                            <h3 className="text-lg font-medium text-gray-900 mb-4">Timeline</h3>
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between py-2">
                                                    <span className="text-sm text-gray-600">Data Inizio</span>
                                                    <span className="text-sm font-medium text-gray-900">{selectedCommessa.DataInizio}</span>
                                                </div>
                                                <div className="flex items-center justify-between py-2">
                                                    <span className="text-sm text-gray-600">Data Fine Prevista</span>
                                                    <span className="text-sm font-medium text-gray-900">{selectedCommessa.DataFinePrevista}</span>
                                                </div>
                                                {selectedCommessa.DataFineEffettiva && (
                                                    <div className="flex items-center justify-between py-2">
                                                        <span className="text-sm text-gray-600">Data Fine Effettiva</span>
                                                        <span className="text-sm font-medium text-green-600">{selectedCommessa.DataFineEffettiva}</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Semilavorati - Solo per commesse di Produzione */}
                                        {selectedCommessa.Tipo === "Produzione" && selectedCommessa.Semilavorati && selectedCommessa.Semilavorati.length > 0 && (
                                            <div className="material-card-elevated rounded-lg p-6 bg-white">
                                                <h3 className="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                                                    <svg className="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M20 2H4c-1 0-2 .9-2 2v3.01c0 .72.43 1.34 1 1.69V20c0 1.1 1.1 2 2 2h14c.9 0 2-.9 2-2V8.7c.57-.35 1-.97 1-1.69V4c0-1.1-1-2-2-2zm-5 12H9v-2h6v2zm5-7H4V4h16v3z"/>
                                                    </svg>
                                                    Dettaglio Semilavorati ({selectedCommessa.Semilavorati.length})
                                                </h3>

                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="text-left bg-purple-50 border-b-2 border-purple-200">
                                                                <th className="py-3 px-3 font-medium text-gray-700">Codice</th>
                                                                <th className="py-3 px-3 font-medium text-gray-700">Descrizione</th>
                                                                <th className="py-3 px-3 font-medium text-gray-700">Fase</th>
                                                                <th className="py-3 px-3 font-medium text-gray-700 text-center">Avanzamento</th>
                                                                <th className="py-3 px-3 font-medium text-gray-700 text-right">Previste</th>
                                                                <th className="py-3 px-3 font-medium text-gray-700 text-right">Prodotte</th>
                                                                <th className="py-3 px-3 font-medium text-gray-700 text-right">Collaudate</th>
                                                                <th className="py-3 px-3 font-medium text-gray-700 text-right">Scarti</th>
                                                                <th className="py-3 px-3 font-medium text-gray-700">Timeline</th>
                                                                <th className="py-3 px-3 font-medium text-gray-700">Note</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {selectedCommessa.Semilavorati.map((sl, idx) => {
                                                                const percentualeCompletamento = sl.QuantitaPrevista > 0 ? (sl.QuantitaProdotta / sl.QuantitaPrevista) * 100 : 0;
                                                                const percentualeCollaudo = sl.QuantitaProdotta > 0 ? (sl.QuantitaCollaudata / sl.QuantitaProdotta) * 100 : 0;
                                                                const percentualeScarti = sl.QuantitaProdotta > 0 ? (sl.QuantitaScarti / sl.QuantitaProdotta) * 100 : 0;

                                                                return (
                                                                    <tr key={idx} className="border-b hover:bg-purple-50/50 transition">
                                                                        {/* Codice */}
                                                                        <td className="py-3 px-3">
                                                                            <span className="font-mono text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded font-medium">
                                                                                {sl.Codice}
                                                                            </span>
                                                                        </td>

                                                                        {/* Descrizione */}
                                                                        <td className="py-3 px-3">
                                                                            <div className="font-medium text-gray-900 max-w-xs">{sl.Descrizione}</div>
                                                                        </td>

                                                                        {/* Fase */}
                                                                        <td className="py-3 px-3">
                                                                            <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                                                                {sl.FaseProduzione}
                                                                            </span>
                                                                        </td>

                                                                        {/* Avanzamento */}
                                                                        <td className="py-3 px-3">
                                                                            <div className="flex flex-col items-center gap-1 min-w-[100px]">
                                                                                <span className="text-xs font-medium text-purple-700">{pctFmt(sl.StatoAvanzamento)}</span>
                                                                                <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                                                                    <div
                                                                                        className="h-full rounded-full bg-gradient-to-r from-purple-500 to-purple-600"
                                                                                        style={{ width: `${sl.StatoAvanzamento}%` }}
                                                                                    />
                                                                                </div>
                                                                            </div>
                                                                        </td>

                                                                        {/* Previste */}
                                                                        <td className="py-3 px-3 text-right">
                                                                            <div className="font-semibold text-gray-900">{sl.QuantitaPrevista}</div>
                                                                        </td>

                                                                        {/* Prodotte */}
                                                                        <td className="py-3 px-3 text-right">
                                                                            <div className="font-semibold text-blue-600">{sl.QuantitaProdotta}</div>
                                                                            <div className="text-xs text-gray-500">{pctFmt(percentualeCompletamento)}</div>
                                                                        </td>

                                                                        {/* Collaudate */}
                                                                        <td className="py-3 px-3 text-right">
                                                                            <div className="font-semibold text-green-600">{sl.QuantitaCollaudata}</div>
                                                                            <div className="text-xs text-gray-500">{pctFmt(percentualeCollaudo)}</div>
                                                                        </td>

                                                                        {/* Scarti */}
                                                                        <td className="py-3 px-3 text-right">
                                                                            <div className={`font-semibold ${percentualeScarti > 5 ? 'text-red-600' : 'text-orange-600'}`}>
                                                                                {sl.QuantitaScarti}
                                                                            </div>
                                                                            <div className={`text-xs ${percentualeScarti > 5 ? 'text-red-600' : 'text-orange-600'}`}>
                                                                                {pctFmt(percentualeScarti)}
                                                                            </div>
                                                                        </td>

                                                                        {/* Timeline */}
                                                                        <td className="py-3 px-3">
                                                                            <div className="text-xs text-gray-600 min-w-[120px]">
                                                                                <div><span className="font-medium">Inizio:</span> {sl.DataInizioPrevista}</div>
                                                                                <div><span className="font-medium">Fine:</span> {sl.DataFinePrevista}</div>
                                                                            </div>
                                                                        </td>

                                                                        {/* Note */}
                                                                        <td className="py-3 px-3">
                                                                            {sl.Note && (
                                                                                <div className="text-xs text-gray-600 max-w-xs">
                                                                                    {sl.Note}
                                                                                </div>
                                                                            )}
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}

                                        {/* Note */}
                                        {selectedCommessa.Note && (
                                            <div className="material-card-elevated rounded-lg p-6 bg-amber-50">
                                                <h3 className="text-lg font-medium text-gray-900 mb-2 flex items-center gap-2">
                                                    <svg className="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                                    </svg>
                                                    Note
                                                </h3>
                                                <p className="text-sm text-gray-700">{selectedCommessa.Note}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <div className="material-card bg-white rounded-lg p-4 flex items-center gap-3 text-sm text-gray-600">
                        <svg className="w-5 h-5 text-teal-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/>
                        </svg>
                        <div>
                            <span className="font-medium">Dati caricati da:</span> {new URLSearchParams(window.location.search).get('data') || 'commesse.json'}
                            <span className="mx-2">¬∑</span>
                            <span className="text-gray-500">Parametri: ?data=file.json&pdf=analisi.pdf&mp3=audio.mp3</span>
                        </div>
                    </div>
                </div>
                </div>
            );
        }

        // Mount
        function App() { return <CommesseDashboard />; }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>

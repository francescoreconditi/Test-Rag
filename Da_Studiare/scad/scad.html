<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Drilldown (demo)</title>
    <!-- Tailwind via CDN (ok per demo; avviso in console è normale) -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <!-- React 18 CDN + Babel per compilare JSX al volo (solo per demo) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- App: versione JS-only (senza import/export/TypeScript) -->
    <script type="text/babel" data-presets="env,react">
        const { useMemo, useState, useEffect } = React;

        // State globale per i dati caricati
        let SUMMARY = null;
        let CLIENTS = [];
        let INVOICES = {};
        let BUCKETS = [];

        function numberFmt(val) { return val.toLocaleString("it-IT", { style: "currency", currency: "EUR", maximumFractionDigits: 0 }); }
        function pctFmt(val) { return `${val.toFixed(1)}%`; }

        function ARDrilldownDashboard() {
            const [selectedBucket, setSelectedBucket] = useState("Tutti");
            const [selectedClient, setSelectedClient] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);

            // Carica i dati dal file JSON
            useEffect(() => {
                // Leggi il parametro 'data' dall'URL, default a 'drill.json'
                const urlParams = new URLSearchParams(window.location.search);
                const dataFile = urlParams.get('data') || 'drill.json';

                console.log(`Caricamento dati da: ${dataFile}`);

                fetch(`./${dataFile}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - File non trovato: ${dataFile}`);
                        }
                        return response.json();
                    })
                    .then(jsonData => {
                        // Aggiorna le variabili globali
                        SUMMARY = jsonData.summary;
                        CLIENTS = jsonData.clients;
                        INVOICES = jsonData.invoices;
                        BUCKETS = jsonData.buckets;

                        // Smoke test minimi (test-case base)
                        console.assert(BUCKETS.includes(">90 gg"), "Test: manca bucket >90 gg");
                        console.assert((INVOICES["Cliente X"] || []).filter(i => i.bucket === ">90 gg").length === 1, "Test: Cliente X dovrebbe avere 1 fattura >90 gg");

                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Errore caricamento dati:', err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            const filteredClients = useMemo(() => {
                if (!data) return [];
                if (selectedBucket === "Tutti") return CLIENTS;
                return CLIENTS.filter((c) => (INVOICES[c.name] || []).some((i) => i.bucket === selectedBucket));
            }, [selectedBucket, data]);

            const kpi = useMemo(() => {
                if (!data) return { total: 0, overdue: 0, bucketValue: 0, bucketPct: 0 };
                const total = SUMMARY.totals.net;
                const overdue = SUMMARY.totals.overdue;
                const agingMap = Object.fromEntries(SUMMARY.aging.map(a => [a.bucket, a.value]));
                const bucketValue = selectedBucket === "Tutti" ? overdue : (agingMap[selectedBucket] || 0);
                const bucketPct = total > 0 ? (bucketValue / total) * 100 : 0;
                return { total, overdue, bucketValue, bucketPct };
            }, [selectedBucket, data]);

            const openClient = (name) => { setSelectedClient(name); setDrawerOpen(true); };

            const currentInvoices = useMemo(() => {
                if (!data) return [];
                const all = (selectedClient && INVOICES[selectedClient]) || [];
                return selectedBucket === "Tutti" ? all : all.filter(i => i.bucket === selectedBucket);
            }, [selectedClient, selectedBucket, data]);

            const totalAging = data ? SUMMARY.aging.reduce((s, a) => s + a.value, 0) || 1 : 1;

            // Schermata di caricamento
            if (loading) {
                return (
                    <div className="w-full h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-2xl font-semibold mb-2">Caricamento dati...</div>
                            <div className="text-gray-500">Attendere prego</div>
                        </div>
                    </div>
                );
            }

            // Schermata di errore
            if (error) {
                return (
                    <div className="w-full h-screen flex items-center justify-center">
                        <div className="text-center max-w-md">
                            <div className="text-2xl font-semibold mb-2 text-red-600">Errore caricamento dati</div>
                            <div className="text-gray-700 mb-4">{error}</div>
                            <div className="text-sm text-gray-500">Assicurati che il file 'drill.json' sia presente nella stessa directory di questo file HTML.</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full p-6 space-y-6">
                    <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h1 className="text-2xl font-semibold">Scadenzario AR — Panoramica</h1>
                            <p className="text-sm text-gray-600">Data riferimento: {SUMMARY.date} · Valuta: {SUMMARY.currency}</p>
                            <div className="mt-2 text-sm text-gray-700">
                                <span className="font-medium">Percorso:</span>{" "}
                                <span>
                                    Panoramica
                                    {selectedBucket !== "Tutti" && <> → <span className="font-medium">{selectedBucket}</span></>}
                                    {selectedClient && <> → <span className="font-medium">{selectedClient}</span></>}
                                </span>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {BUCKETS.map((b) => (
                                <button key={b} onClick={() => setSelectedBucket(b)}
                                    className={`px-3 py-1 rounded-full border text-sm transition ${selectedBucket === b ? "bg-black text-white" : "bg-white hover:bg-gray-100"}`}>
                                    {b}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">Crediti netti</div>
                            <div className="text-2xl font-semibold">{numberFmt(kpi.total)}</div>
                            <div className="mt-2 text-xs text-gray-500">Lordi {numberFmt(SUMMARY.totals.gross)} · Fondo {numberFmt(SUMMARY.totals.allowance)}</div>
                        </div>
                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">Scaduto totale</div>
                            <div className="text-2xl font-semibold">{numberFmt(kpi.overdue)}</div>
                            <div className="mt-2 text-xs text-gray-500">{pctFmt(SUMMARY.totals.overduePct)} del totale</div>
                        </div>
                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">DSO (doc.)</div>
                            <div className="text-2xl font-semibold">{SUMMARY.totals.dso} giorni</div>
                            <div className="mt-2 text-xs text-gray-500">Metodo: crediti medi / vendite giornaliere × 365</div>
                        </div>
                    </div>

                    <div className="rounded-2xl border p-4 shadow-sm bg-white">
                        <div className="flex items-center justify-between mb-3">
                            <div className="font-medium">Distribuzione per aging</div>
                            <div className="text-sm text-gray-500">Click su una sezione per filtrare</div>
                        </div>
                        <div className="flex w-full h-8 overflow-hidden rounded-lg border">
                            {SUMMARY.aging.map((a) => {
                                const w = (a.value / totalAging) * 100;
                                const active = selectedBucket === a.bucket;
                                return (
                                    <button key={a.bucket} title={`${a.bucket} — ${numberFmt(a.value)}`}
                                        onClick={() => setSelectedBucket(a.bucket)}
                                        style={{ width: `${w}%` }}
                                        className={`h-full text-[10px] md:text-xs flex items-center justify-center border-r last:border-r-0 transition ${active ? "bg-black text-white" : "bg-gray-100 hover:bg-gray-200"}`}>
                                        <div className="px-1 truncate">{a.bucket}</div>
                                    </button>
                                );
                            })}
                        </div>
                        <div className="mt-3 text-sm text-gray-700">
                            <span className="font-medium">Quota selezionata: </span>
                            {numberFmt(kpi.bucketValue)} ({pctFmt(kpi.bucketPct)}) su crediti netti
                        </div>
                    </div>

                    <div className="rounded-2xl border p-4 shadow-sm bg-white">
                        <div className="flex items-center justify-between mb-3">
                            <div className="font-medium">Top clienti</div>
                            <div className="text-sm text-gray-500">Click su una riga per il drill-down</div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="text-left text-gray-500 border-b">
                                        <th className="py-2 pr-4">Cliente</th>
                                        <th className="py-2 pr-4">Esposizione</th>
                                        <th className="py-2 pr-4">Quota su totale</th>
                                        <th className="py-2 pr-4">{"Quota >90 gg"}</th>
                                        <th className="py-2"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredClients.map((c, idx) => {
                                        const pct = (c.total / SUMMARY.totals.net) * 100;
                                        const gt90pct = c.total ? (c.gt90 / c.total) * 100 : 0;
                                        return (
                                            <tr key={c.name} className="border-b hover:bg-gray-50 cursor-pointer" onClick={() => { setSelectedClient(c.name); setDrawerOpen(true); }}>
                                                <td className="py-2 pr-4"><div className="font-medium">{idx + 1}. {c.name}</div></td>
                                                <td className="py-2 pr-4">{numberFmt(c.total)}</td>
                                                <td className="py-2 pr-4">{pctFmt(pct)}</td>
                                                <td className="py-2 pr-4">{pctFmt(gt90pct)}</td>
                                                <td className="py-2 text-right"><span className="text-xs text-blue-600 underline">Dettagli</span></td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    { /* Drawer */}
                    {drawerOpen && (
                        <div className="fixed inset-0 z-40">
                            <div className="absolute inset-0 bg-black/30" onClick={() => setDrawerOpen(false)} />
                            <div className="absolute right-0 top-0 h-full w-full sm:w-[520px] bg-white shadow-2xl p-6 overflow-y-auto">
                                <div className="flex items-start justify-between gap-4">
                                    <div>
                                        <div className="text-xs text-gray-500">Dettaglio</div>
                                        <h2 className="text-xl font-semibold">{selectedClient} {selectedBucket !== "Tutti" && `— ${selectedBucket}`}</h2>
                                    </div>
                                    <button className="text-sm px-3 py-1 rounded-md border hover:bg-gray-50" onClick={() => setDrawerOpen(false)}>Chiudi</button>
                                </div>

                                <div className="mt-4 flex flex-wrap gap-2">
                                    {BUCKETS.map((b) => (
                                        <button key={b} onClick={() => setSelectedBucket(b)}
                                            className={`px-3 py-1 rounded-full border text-sm transition ${selectedBucket === b ? "bg-black text-white" : "bg-white hover:bg-gray-100"}`}>
                                            {b}
                                        </button>
                                    ))}
                                </div>

                                <div className="mt-4">
                                    <div className="text-sm font-medium mb-2">Fatture ({(selectedClient && (INVOICES[selectedClient] || []).filter(i => selectedBucket === "Tutti" || i.bucket === selectedBucket).length) || 0})</div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="text-left text-gray-500 border-b">
                                                    <th className="py-2 pr-3">Tipo</th>
                                                    <th className="py-2 pr-3">N. Doc</th>
                                                    <th className="py-2 pr-3">Data Doc</th>
                                                    <th className="py-2 pr-3">Scadenza</th>
                                                    <th className="py-2 pr-3">Residuo</th>
                                                    <th className="py-2 pr-3">Bucket</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {((selectedClient && (INVOICES[selectedClient] || [])) || [])
                                                    .filter(i => selectedBucket === "Tutti" || i.bucket === selectedBucket)
                                                    .map((i, idx) => (
                                                        <tr key={idx} className="border-b last:border-b-0">
                                                            <td className="py-2 pr-3">{i.docType}</td>
                                                            <td className="py-2 pr-3">{i.docNo}</td>
                                                            <td className="py-2 pr-3">{i.docDate}</td>
                                                            <td className="py-2 pr-3">{i.dueDate}</td>
                                                            <td className="py-2 pr-3">{numberFmt(i.residual)}</td>
                                                            <td className="py-2 pr-3">{i.bucket}</td>
                                                        </tr>
                                                    ))}
                                                {(!selectedClient || ((INVOICES[selectedClient] || []).filter(i => selectedBucket === "Tutti" || i.bucket === selectedBucket).length === 0)) && (
                                                    <tr><td colSpan="6" className="py-6 text-center text-gray-500">Nessuna fattura per il filtro selezionato.</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="mt-6 rounded-xl border p-4 bg-gray-50">
                                    <div className="text-sm font-medium mb-1">Spiegazione (LLM) del drill-down selezionato</div>
                                    <p className="text-xs text-gray-600">Quando l'utente apre questo pannello, invia al modello le righe filtrate come <em>contesto</em> + un prompt breve.</p>
                                    <pre className="mt-3 text-xs whitespace-pre-wrap leading-5 bg-white p-3 rounded-md border overflow-x-auto">
                                        {`Prompt (esempio):
Sei un credit/AR analyst. Spiega in 120–180 parole il dettaglio selezionato, citando le fonti come "riga X".
Contesto: fatture di ${'${selectedClient || "<cliente>"}'} nel bucket ${'${selectedBucket}'} al ${'${SUMMARY.date}'}, valuta EUR.
Obiettivi: indica importi rilevanti, incidenze %, e rischi/azioni (contenziosi, promesse di pagamento, dilazioni se note).`}
                                    </pre>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="text-xs text-gray-500">
                        Dati caricati da: {new URLSearchParams(window.location.search).get('data') || 'drill.json'} |
                        Suggerimento: usa ?data=nome_file.json per caricare dati diversi
                    </div>
                </div>
            );
        }

        // Mount
        function App() { return <ARDrilldownDashboard />; }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>

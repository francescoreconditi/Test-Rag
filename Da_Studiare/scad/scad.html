<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Drilldown (demo)</title>
    <!-- Tailwind via CDN (ok per demo; avviso in console √® normale) -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <!-- React 18 CDN + Babel per compilare JSX al volo (solo per demo) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- App: versione JS-only (senza import/export/TypeScript) -->
    <script type="text/babel" data-presets="env,react">
        const { useMemo, useState, useEffect } = React;

        // State globale per i dati caricati
        let SUMMARY = null;
        let CLIENTS = [];
        let INVOICES = {};
        let BUCKETS = [];

        function numberFmt(val) { return val.toLocaleString("it-IT", { style: "currency", currency: "EUR", maximumFractionDigits: 0 }); }
        function pctFmt(val) { return `${val.toFixed(1)}%`; }

        function ARDrilldownDashboard() {
            const [selectedBucket, setSelectedBucket] = useState("Tutti");
            const [selectedClient, setSelectedClient] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);

            // Carica i dati dal file JSON
            useEffect(() => {
                // Leggi il parametro 'data' dall'URL, default a 'drill.json'
                const urlParams = new URLSearchParams(window.location.search);
                const dataFile = urlParams.get('data') || 'drill.json';

                console.log(`Caricamento dati da: ${dataFile}`);

                fetch(`./${dataFile}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - File non trovato: ${dataFile}`);
                        }
                        return response.json();
                    })
                    .then(jsonData => {
                        // Aggiorna le variabili globali
                        SUMMARY = jsonData.summary;
                        CLIENTS = jsonData.clients;
                        INVOICES = jsonData.invoices;
                        BUCKETS = jsonData.buckets;

                        // Smoke test minimi (test-case base)
                        console.assert(BUCKETS.includes(">90 gg"), "Test: manca bucket >90 gg");
                        console.assert((INVOICES["Cliente X"] || []).filter(i => i.bucket === ">90 gg").length === 1, "Test: Cliente X dovrebbe avere 1 fattura >90 gg");

                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Errore caricamento dati:', err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            const filteredClients = useMemo(() => {
                if (!data) return [];
                if (selectedBucket === "Tutti") return CLIENTS;
                return CLIENTS.filter((c) => (INVOICES[c.name] || []).some((i) => i.bucket === selectedBucket));
            }, [selectedBucket, data]);

            const kpi = useMemo(() => {
                if (!data) return { total: 0, overdue: 0, bucketValue: 0, bucketPct: 0 };
                const total = SUMMARY.totals.net;
                const overdue = SUMMARY.totals.overdue;
                const agingMap = Object.fromEntries(SUMMARY.aging.map(a => [a.bucket, a.value]));
                const bucketValue = selectedBucket === "Tutti" ? overdue : (agingMap[selectedBucket] || 0);
                const bucketPct = total > 0 ? (bucketValue / total) * 100 : 0;
                return { total, overdue, bucketValue, bucketPct };
            }, [selectedBucket, data]);

            const openClient = (name) => { setSelectedClient(name); setDrawerOpen(true); };

            const currentInvoices = useMemo(() => {
                if (!data) return [];
                const all = (selectedClient && INVOICES[selectedClient]) || [];
                return selectedBucket === "Tutti" ? all : all.filter(i => i.bucket === selectedBucket);
            }, [selectedClient, selectedBucket, data]);

            const totalAging = data ? SUMMARY.aging.reduce((s, a) => s + a.value, 0) || 1 : 1;

            // Schermata di caricamento
            if (loading) {
                return (
                    <div className="w-full h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-2xl font-semibold mb-2">üìä Caricamento scadenzario...</div>
                            <div className="text-gray-500">Attendere prego</div>
                        </div>
                    </div>
                );
            }

            // Schermata di errore
            if (error) {
                return (
                    <div className="w-full h-screen flex items-center justify-center">
                        <div className="text-center max-w-md">
                            <div className="text-2xl font-semibold mb-2 text-red-600">‚ùå Errore caricamento dati</div>
                            <div className="text-gray-700 mb-4">{error}</div>
                            <div className="text-sm text-gray-500">Assicurati che il file JSON sia presente nella directory corretta.</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full p-6 space-y-6">
                    <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h1 className="text-2xl font-semibold">üí≥ Scadenzario AR ‚Äî Panoramica</h1>
                            <p className="text-sm text-gray-600">Data riferimento: {SUMMARY.date} ¬∑ Valuta: {SUMMARY.currency}</p>
                            <div className="mt-2 text-sm text-gray-700">
                                <span className="font-medium">Percorso:</span>{" "}
                                <span>
                                    Panoramica
                                    {selectedBucket !== "Tutti" && <> ‚Üí <span className="font-medium">{selectedBucket}</span></>}
                                    {selectedClient && <> ‚Üí <span className="font-medium">{selectedClient}</span></>}
                                </span>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {BUCKETS.map((b) => {
                                const getBucketColor = (bucket) => {
                                    if (bucket === "Tutti") return "bg-gray-100 text-gray-800 border-gray-300";
                                    if (bucket === "Non scaduto") return "bg-green-50 text-green-700 border-green-200";
                                    if (bucket === "0‚Äì30 gg") return "bg-blue-50 text-blue-700 border-blue-200";
                                    if (bucket === "31‚Äì60 gg") return "bg-yellow-50 text-yellow-700 border-yellow-200";
                                    if (bucket === "61‚Äì90 gg") return "bg-orange-50 text-orange-700 border-orange-200";
                                    if (bucket === ">90 gg") return "bg-red-50 text-red-700 border-red-200";
                                    return "bg-white";
                                };
                                const isActive = selectedBucket === b;
                                return (
                                    <button key={b} onClick={() => setSelectedBucket(b)}
                                        className={`px-3 py-1 rounded-full border text-sm transition ${isActive ? "bg-black text-white border-black" : getBucketColor(b) + " hover:shadow-md"}`}>
                                        {b}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="rounded-2xl border border-green-200 p-4 shadow-sm bg-gradient-to-br from-green-50 to-white">
                            <div className="flex items-center justify-between mb-1">
                                <div className="text-sm text-gray-500">üí∞ Crediti netti</div>
                            </div>
                            <div className="text-2xl font-semibold text-green-900">{numberFmt(kpi.total)}</div>
                            <div className="mt-2 text-xs text-gray-600">Lordi {numberFmt(SUMMARY.totals.gross)} ¬∑ Fondo {numberFmt(SUMMARY.totals.allowance)}</div>
                        </div>
                        <div className="rounded-2xl border border-red-200 p-4 shadow-sm bg-gradient-to-br from-red-50 to-white">
                            <div className="flex items-center justify-between mb-1">
                                <div className="text-sm text-gray-500">‚ö†Ô∏è Scaduto totale</div>
                            </div>
                            <div className="text-2xl font-semibold text-red-900">{numberFmt(kpi.overdue)}</div>
                            <div className="mt-2 text-xs text-red-700 font-medium">{pctFmt(SUMMARY.totals.overduePct)} del totale</div>
                        </div>
                        <div className="rounded-2xl border border-blue-200 p-4 shadow-sm bg-gradient-to-br from-blue-50 to-white">
                            <div className="flex items-center justify-between mb-1">
                                <div className="text-sm text-gray-500">üìÖ DSO (doc.)</div>
                            </div>
                            <div className="text-2xl font-semibold text-blue-900">{SUMMARY.totals.dso} giorni</div>
                            <div className="mt-2 text-xs text-gray-600">Crediti medi / vendite gg √ó 365</div>
                        </div>
                    </div>

                    <div className="rounded-2xl border border-purple-200 p-4 shadow-sm bg-gradient-to-br from-purple-50 to-white">
                        <div className="flex items-center justify-between mb-3">
                            <div className="font-medium">üìä Distribuzione per aging</div>
                            <div className="text-sm text-gray-500">Click su una sezione per filtrare</div>
                        </div>
                        <div className="flex w-full h-10 overflow-hidden rounded-lg border shadow-inner">
                            {SUMMARY.aging.map((a) => {
                                const w = (a.value / totalAging) * 100;
                                const active = selectedBucket === a.bucket;
                                const getAgingColor = (bucket) => {
                                    if (bucket === "Non scaduto") return "bg-green-500";
                                    if (bucket === "0‚Äì30 gg") return "bg-blue-500";
                                    if (bucket === "31‚Äì60 gg") return "bg-yellow-500";
                                    if (bucket === "61‚Äì90 gg") return "bg-orange-500";
                                    if (bucket === ">90 gg") return "bg-red-500";
                                    return "bg-gray-400";
                                };
                                return (
                                    <button key={a.bucket} title={`${a.bucket} ‚Äî ${numberFmt(a.value)}`}
                                        onClick={() => setSelectedBucket(a.bucket)}
                                        style={{ width: `${w}%` }}
                                        className={`h-full text-[10px] md:text-xs flex items-center justify-center border-r last:border-r-0 transition font-medium ${active ? "ring-2 ring-black ring-inset scale-105 z-10" : ""} ${getAgingColor(a.bucket)} text-white hover:opacity-90`}>
                                        <div className="px-1 truncate">{a.bucket}</div>
                                    </button>
                                );
                            })}
                        </div>
                        <div className="mt-3 text-sm text-gray-700">
                            <span className="font-medium">Quota selezionata: </span>
                            <span className="text-purple-900 font-semibold">{numberFmt(kpi.bucketValue)}</span> ({pctFmt(kpi.bucketPct)}) su crediti netti
                        </div>
                    </div>

                    <div className="rounded-2xl border border-indigo-200 p-4 shadow-sm bg-gradient-to-br from-indigo-50 to-white">
                        <div className="flex items-center justify-between mb-3">
                            <div className="font-medium">üë• Top clienti ({filteredClients.length})</div>
                            <div className="text-sm text-gray-500">Click su una riga per il drill-down</div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="text-left text-gray-500 border-b-2 border-gray-300">
                                        <th className="py-2 pr-4">Cliente</th>
                                        <th className="py-2 pr-4">Esposizione</th>
                                        <th className="py-2 pr-4">Quota su totale</th>
                                        <th className="py-2 pr-4">{"Quota >90 gg"}</th>
                                        <th className="py-2"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredClients.map((c, idx) => {
                                        const pct = (c.total / SUMMARY.totals.net) * 100;
                                        const gt90pct = c.total ? (c.gt90 / c.total) * 100 : 0;
                                        const getRiskBadge = (pct) => {
                                            if (pct > 30) return <span className="ml-2 px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full">‚ö†Ô∏è Alto</span>;
                                            if (pct > 10) return <span className="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded-full">‚ö° Medio</span>;
                                            if (pct > 0) return <span className="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">üëÅÔ∏è Basso</span>;
                                            return <span className="ml-2 px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">‚úì OK</span>;
                                        };
                                        return (
                                            <tr key={c.name} className="border-b hover:bg-indigo-100 cursor-pointer transition" onClick={() => { setSelectedClient(c.name); setDrawerOpen(true); }}>
                                                <td className="py-3 pr-4"><div className="font-medium">{idx + 1}. {c.name}</div></td>
                                                <td className="py-3 pr-4 font-semibold">{numberFmt(c.total)}</td>
                                                <td className="py-3 pr-4">{pctFmt(pct)}</td>
                                                <td className="py-3 pr-4">
                                                    <div className="flex items-center">
                                                        {pctFmt(gt90pct)}
                                                        {getRiskBadge(gt90pct)}
                                                    </div>
                                                </td>
                                                <td className="py-3 text-right"><span className="text-xs text-blue-600 underline font-medium">Dettagli ‚Üí</span></td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    { /* Drawer */}
                    {drawerOpen && (
                        <div className="fixed inset-0 z-40">
                            <div className="absolute inset-0 bg-black/30" onClick={() => setDrawerOpen(false)} />
                            <div className="absolute bottom-0 left-0 w-full h-[70vh] bg-white shadow-2xl p-6 overflow-y-auto rounded-t-2xl">
                                <div className="flex items-start justify-between gap-4 mb-6">
                                    <div>
                                        <div className="text-xs text-gray-500 mb-1">Dettaglio Cliente</div>
                                        <h2 className="text-xl font-semibold">üë§ {selectedClient}</h2>
                                        {selectedBucket !== "Tutti" && <div className="mt-1 inline-block px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">{selectedBucket}</div>}
                                    </div>
                                    <button className="text-sm px-4 py-2 rounded-lg border hover:bg-gray-50 transition font-medium" onClick={() => setDrawerOpen(false)}>‚úï Chiudi</button>
                                </div>

                                <div className="flex flex-wrap gap-2 mb-4">
                                    {BUCKETS.map((b) => {
                                        const getBucketColor = (bucket) => {
                                            if (bucket === "Tutti") return "bg-gray-100 text-gray-800 border-gray-300";
                                            if (bucket === "Non scaduto") return "bg-green-50 text-green-700 border-green-200";
                                            if (bucket === "0‚Äì30 gg") return "bg-blue-50 text-blue-700 border-blue-200";
                                            if (bucket === "31‚Äì60 gg") return "bg-yellow-50 text-yellow-700 border-yellow-200";
                                            if (bucket === "61‚Äì90 gg") return "bg-orange-50 text-orange-700 border-orange-200";
                                            if (bucket === ">90 gg") return "bg-red-50 text-red-700 border-red-200";
                                            return "bg-white";
                                        };
                                        const isActive = selectedBucket === b;
                                        return (
                                            <button key={b} onClick={() => setSelectedBucket(b)}
                                                className={`px-3 py-1 rounded-full border text-sm transition ${isActive ? "bg-black text-white border-black" : getBucketColor(b) + " hover:shadow-md"}`}>
                                                {b}
                                            </button>
                                        );
                                    })}
                                </div>

                                <div className="rounded-lg border border-gray-200 bg-gray-50 p-4">
                                    <div className="text-sm font-medium mb-3">üìÑ Fatture ({(selectedClient && (INVOICES[selectedClient] || []).filter(i => selectedBucket === "Tutti" || i.bucket === selectedBucket).length) || 0})</div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="text-left text-gray-500 border-b-2 border-gray-300 bg-gray-100">
                                                    <th className="py-2 pr-3 pl-2">Tipo</th>
                                                    <th className="py-2 pr-3">N. Doc</th>
                                                    <th className="py-2 pr-3">Data Doc</th>
                                                    <th className="py-2 pr-3">Scadenza</th>
                                                    <th className="py-2 pr-3">Residuo</th>
                                                    <th className="py-2 pr-3">Aging</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white">
                                                {((selectedClient && (INVOICES[selectedClient] || [])) || [])
                                                    .filter(i => selectedBucket === "Tutti" || i.bucket === selectedBucket)
                                                    .map((i, idx) => {
                                                        const getBucketBadge = (bucket) => {
                                                            if (bucket === "Non scaduto") return "bg-green-100 text-green-800";
                                                            if (bucket === "0‚Äì30 gg") return "bg-blue-100 text-blue-800";
                                                            if (bucket === "31‚Äì60 gg") return "bg-yellow-100 text-yellow-800";
                                                            if (bucket === "61‚Äì90 gg") return "bg-orange-100 text-orange-800";
                                                            if (bucket === ">90 gg") return "bg-red-100 text-red-800";
                                                            return "bg-gray-100 text-gray-800";
                                                        };
                                                        return (
                                                            <tr key={idx} className="border-b last:border-b-0 hover:bg-gray-50">
                                                                <td className="py-3 pr-3 pl-2"><span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded font-mono">{i.docType}</span></td>
                                                                <td className="py-3 pr-3 font-mono text-sm">{i.docNo}</td>
                                                                <td className="py-3 pr-3 text-sm">{i.docDate}</td>
                                                                <td className="py-3 pr-3 text-sm">{i.dueDate}</td>
                                                                <td className="py-3 pr-3 font-semibold">{numberFmt(i.residual)}</td>
                                                                <td className="py-3 pr-3"><span className={`px-2 py-1 text-xs rounded-full ${getBucketBadge(i.bucket)}`}>{i.bucket}</span></td>
                                                            </tr>
                                                        );
                                                    })}
                                                {(!selectedClient || ((INVOICES[selectedClient] || []).filter(i => selectedBucket === "Tutti" || i.bucket === selectedBucket).length === 0)) && (
                                                    <tr><td colSpan="6" className="py-6 text-center text-gray-500">Nessuna fattura per il filtro selezionato.</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="mt-6 rounded-xl border border-purple-200 p-4 bg-gradient-to-br from-purple-50 to-white">
                                    <div className="text-sm font-medium mb-1">ü§ñ Analisi AI (esempio integrazione LLM)</div>
                                    <p className="text-xs text-gray-600 mb-3">Quando l'utente apre questo pannello, il sistema pu√≤ inviare i dati al modello per un'analisi automatica del rischio creditizio.</p>
                                    <pre className="text-xs whitespace-pre-wrap leading-5 bg-white p-3 rounded-md border overflow-x-auto shadow-inner">
{`Prompt (esempio):
Sei un credit/AR analyst. Analizza il dettaglio del cliente "${selectedClient}".
Filtro aging: ${selectedBucket}
Data riferimento: ${SUMMARY.date}
Valuta: EUR

Fornisci:
- Valutazione rischio credito (Alto/Medio/Basso)
- Importi rilevanti e incidenze %
- Trend scaduto (miglioramento/peggioramento)
- Azioni raccomandate (sollecito, dilazione, contenzioso)

Rispondi in 150-200 parole citando documenti specifici.`}
                                    </pre>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="rounded-lg border border-gray-200 bg-white p-3 text-xs text-gray-500 flex items-center justify-between">
                        <div>
                            <span className="font-medium">üìÅ Dati caricati da:</span> {new URLSearchParams(window.location.search).get('data') || 'drill.json'}
                        </div>
                        <div className="text-gray-400">
                            üí° Tip: usa <code className="px-1.5 py-0.5 bg-gray-100 rounded">?data=file.json</code> per caricare file diversi
                        </div>
                    </div>
                </div>
            );
        }

        // Mount
        function App() { return <ARDrilldownDashboard />; }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>

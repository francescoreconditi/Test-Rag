<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Contabilità Analitica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2pdf.js per export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Roboto', sans-serif; }
        .material-card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        .material-card:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            transform: translateY(-2px);
        }
        .material-card-elevated {
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:active::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: ripple-animation 0.6s ease-out;
        }
        @keyframes ripple-animation {
            to { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react">
        const { useMemo, useState, useEffect } = React;

        // Variabili globali per i dati
        let PERIODO = "";
        let CENTRI_DI_COSTO = [];
        let PDF_ANALISI = "";
        let MP3_ANALISI = "";

        function numberFmt(val) {
            return val.toLocaleString("it-IT", {
                style: "currency",
                currency: "EUR",
                maximumFractionDigits: 0
            });
        }

        function pctFmt(val) { return `${val.toFixed(1)}%`; }

        // Funzione per esportare in PDF
        function exportToPDF() {
            const element = document.getElementById('dashboard-content');
            const opt = {
                margin: 10,
                filename: `Dashboard_BCDC_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function calcVariance(actual, target) {
            if (!target) return 0;
            return ((actual - target) / target) * 100;
        }

        // Palette colori rotativi per centri di costo
        const COLOR_PALETTE = [
            "bg-blue-50 border-blue-200",
            "bg-green-50 border-green-200",
            "bg-purple-50 border-purple-200",
            "bg-orange-50 border-orange-200",
            "bg-cyan-50 border-cyan-200",
            "bg-yellow-50 border-yellow-200",
            "bg-pink-50 border-pink-200",
            "bg-indigo-50 border-indigo-200",
            "bg-red-50 border-red-200",
            "bg-teal-50 border-teal-200"
        ];

        // Icone SVG Material Design per tipo
        const ICONS_SVG = {
            "Produzione": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/></svg>',
            "Commerciale": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"/><path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"/></svg>',
            "Amministrazione": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg>',
            "R&D": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 2a1 1 0 00-.707 1.707L7 4.414v3.758a1 1 0 01-.293.707l-4 4C.817 14.769 2.156 18 4.828 18h10.343c2.673 0 4.012-3.231 2.122-5.121l-4-4A1 1 0 0113 8.172V4.414l.707-.707A1 1 0 0013 2H7zm2 6.172V4h2v4.172a3 3 0 00.879 2.12l1.027 1.028a4 4 0 00-2.171.102l-.47.156a4 4 0 01-2.53 0l-.563-.187a1.993 1.993 0 00-.114-.035l1.063-1.063A3 3 0 009 8.172z" clip-rule="evenodd"/></svg>',
            "IT": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"/></svg>',
            "Logistica": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/><path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/></svg>',
            "Marketing": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/></svg>',
            "HR": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/></svg>',
            "Vendite": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/></svg>',
            "Acquisti": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/></svg>',
            "Qualità": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
            "Magazzino": '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"/><path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"/></svg>'
        };

        function getColorForIndex(index) {
            return COLOR_PALETTE[index % COLOR_PALETTE.length];
        }

        function getIconForType(tipo) {
            return ICONS_SVG[tipo] || '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>';
        }

        function BcdcDashboard() {
            const [selectedCdc, setSelectedCdc] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);

            // Carica dati dal JSON
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const dataFile = urlParams.get('data') || 'bcdc.json';
                PDF_ANALISI = urlParams.get('pdf') || '';
                MP3_ANALISI = urlParams.get('mp3') || '';

                console.log(`Caricamento dati da: ${dataFile}`);
                console.log(`PDF Analisi: ${PDF_ANALISI || 'Non specificato'}`);
                console.log(`MP3 Analisi: ${MP3_ANALISI || 'Non specificato'}`);

                fetch(dataFile)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - File non trovato: ${dataFile}`);
                        }
                        return response.json();
                    })
                    .then(jsonData => {
                        PERIODO = jsonData.Periodo;
                        CENTRI_DI_COSTO = jsonData.CentriDiCosto;
                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Errore caricamento dati:', err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            const kpiSummary = useMemo(() => {
                if (!data) return null;

                let totaleRicavi = 0;
                let totaleCosti = 0;
                let totaleRicaviAP = 0;
                let totaleCostiAP = 0;
                let totaleCostiPersonale = 0;
                let totaleCostiOperativi = 0;

                CENTRI_DI_COSTO.forEach(cdc => {
                    totaleRicavi += cdc.Consuntivo.Ricavi || 0;
                    totaleCosti += cdc.Consuntivo.Costi || 0;
                    totaleRicaviAP += cdc.AnnoPrecedente?.Ricavi || 0;
                    totaleCostiAP += cdc.AnnoPrecedente?.Costi || 0;
                    totaleCostiPersonale += cdc.Consuntivo.CostoPersonale || 0;
                    totaleCostiOperativi += cdc.Consuntivo.CostiOperativi || 0;
                });

                const margine = totaleRicavi - totaleCosti;
                const margineAP = totaleRicaviAP - totaleCostiAP;
                const marginePercent = totaleRicavi ? (margine / totaleRicavi) * 100 : 0;

                return {
                    totaleRicavi,
                    totaleCosti,
                    margine,
                    marginePercent,
                    ricaviVar: calcVariance(totaleRicavi, totaleRicaviAP),
                    costiVar: calcVariance(totaleCosti, totaleCostiAP),
                    margineVar: calcVariance(margine, margineAP),
                    totaleCostiPersonale,
                    totaleCostiOperativi,
                    incidenzaPersonale: totaleCosti ? (totaleCostiPersonale / totaleCosti) * 100 : 0
                };
            }, [data]);

            if (loading) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="material-card bg-white rounded-2xl p-8 max-w-md animate-fadeIn">
                            <div className="flex flex-col items-center">
                                <svg className="w-16 h-16 text-blue-500 animate-spin mb-4" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <div className="text-xl font-medium text-gray-900 mb-2">Caricamento contabilità analitica</div>
                                <div className="text-sm text-gray-500">Attendere prego...</div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="material-card bg-white rounded-2xl p-8 max-w-md animate-fadeIn">
                            <div className="flex flex-col items-center text-center">
                                <svg className="w-16 h-16 text-red-500 mb-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"/>
                                </svg>
                                <div className="text-xl font-medium text-red-600 mb-2">Errore caricamento dati</div>
                                <div className="text-gray-700 mb-4">{error}</div>
                                <div className="text-sm text-gray-500">Assicurati che il file JSON sia presente nella directory.</div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full min-h-screen bg-gray-50">
                    {/* AppBar Material */}
                    <div className="material-card-elevated bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 mb-6">
                        <div className="flex items-center gap-3 mb-2">
                            <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                            <h1 className="text-2xl font-medium">Dashboard Contabilità Analitica</h1>
                        </div>
                        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div className="text-sm opacity-90">
                                <span className="font-medium">Periodo:</span> {PERIODO} · <span className="font-medium">Valuta:</span> EUR
                            </div>
                            <div className="flex gap-2">
                                <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium">Consuntivo</div>
                                <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium">Budget</div>
                                <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium">Anno Prec.</div>
                            </div>
                        </div>
                        <div className="mt-2 text-sm opacity-75 flex items-center gap-1">
                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z" clipRule="evenodd"/>
                            </svg>
                            <span>Panoramica Centri di Costo</span>
                            {selectedCdc && <><span>→</span><span className="font-medium">{selectedCdc.Nome}</span></>}
                        </div>
                    </div>

                    <div className="px-6 space-y-6 pb-6">

                    {/* Sezione Analisi - Mostrata solo se c'è almeno un file */}
                    {(PDF_ANALISI || MP3_ANALISI) && (
                        <div className="material-card bg-white rounded-lg p-6">
                            <div className="flex items-center gap-3 mb-4">
                                <svg className="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                                </svg>
                                <h2 className="text-xl font-medium text-gray-900">Analisi</h2>
                            </div>
                            <div className={`grid grid-cols-1 ${PDF_ANALISI && MP3_ANALISI ? 'md:grid-cols-2' : ''} gap-4`}>
                                {/* PDF Link */}
                                {PDF_ANALISI && (
                                    <a
                                        href={PDF_ANALISI}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="flex items-center gap-3 p-4 bg-gradient-to-r from-red-50 to-red-100 rounded-lg hover:from-red-100 hover:to-red-200 transition-all ripple group"
                                    >
                                        <div className="bg-red-600 text-white p-3 rounded-lg group-hover:scale-110 transition-transform">
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/>
                                            </svg>
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900">Analisi Riassuntiva (PDF)</div>
                                            <div className="text-sm text-gray-600">Rapporto completo dei dati del bilancio</div>
                                        </div>
                                        <svg className="w-5 h-5 text-red-600 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                        </svg>
                                    </a>
                                )}

                                {/* MP3 Link - Condizionale */}
                                {MP3_ANALISI && (
                                    <a
                                        href={MP3_ANALISI}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="flex items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg hover:from-purple-100 hover:to-purple-200 transition-all ripple group"
                                    >
                                        <div className="bg-purple-600 text-white p-3 rounded-lg group-hover:scale-110 transition-transform">
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
                                            </svg>
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900">Podcast Analisi (MP3)</div>
                                            <div className="text-sm text-gray-600">Commento audio dei dati principali</div>
                                        </div>
                                        <svg className="w-5 h-5 text-purple-600 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                        </svg>
                                    </a>
                                )}
                            </div>
                        </div>
                    )}

                    {/* KPI Cards Material */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="material-card bg-white rounded-2xl p-5 border-l-4 border-emerald-500 ripple">
                            <div className="flex items-center justify-between mb-3">
                                <svg className="w-8 h-8 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd"/>
                                </svg>
                            </div>
                            <div className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Ricavi Totali</div>
                            <div className="text-2xl font-semibold text-gray-900 mb-2">{numberFmt(kpiSummary.totaleRicavi)}</div>
                            <div className="text-xs flex items-center gap-1">
                                <span className={kpiSummary.ricaviVar >= 0 ? "text-emerald-600 font-medium" : "text-red-600 font-medium"}>
                                    {kpiSummary.ricaviVar >= 0 ? "↑" : "↓"} {pctFmt(Math.abs(kpiSummary.ricaviVar))}
                                </span>
                                <span className="text-gray-500">vs Anno Prec.</span>
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-2xl p-5 border-l-4 border-amber-500 ripple">
                            <div className="flex items-center justify-between mb-3">
                                <svg className="w-8 h-8 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clipRule="evenodd"/>
                                </svg>
                            </div>
                            <div className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Costi Totali</div>
                            <div className="text-2xl font-semibold text-gray-900 mb-2">{numberFmt(kpiSummary.totaleCosti)}</div>
                            <div className="text-xs flex items-center gap-1">
                                <span className={kpiSummary.costiVar <= 0 ? "text-emerald-600 font-medium" : "text-red-600 font-medium"}>
                                    {kpiSummary.costiVar >= 0 ? "↑" : "↓"} {pctFmt(Math.abs(kpiSummary.costiVar))}
                                </span>
                                <span className="text-gray-500">vs Anno Prec.</span>
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-2xl p-5 border-l-4 border-blue-500 ripple">
                            <div className="flex items-center justify-between mb-3">
                                <svg className="w-8 h-8 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clipRule="evenodd"/>
                                </svg>
                            </div>
                            <div className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Margine Operativo</div>
                            <div className="text-2xl font-semibold text-gray-900 mb-2">{numberFmt(kpiSummary.margine)}</div>
                            <div className="text-xs flex items-center gap-1">
                                <span className={kpiSummary.margineVar >= 0 ? "text-emerald-600 font-medium" : "text-red-600 font-medium"}>
                                    {kpiSummary.margineVar >= 0 ? "↑" : "↓"} {pctFmt(Math.abs(kpiSummary.margineVar))}
                                </span>
                                <span className="text-gray-500">vs Anno Prec.</span>
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-2xl p-5 border-l-4 border-purple-500 ripple">
                            <div className="flex items-center justify-between mb-3">
                                <svg className="w-8 h-8 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                                </svg>
                            </div>
                            <div className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Margine %</div>
                            <div className="text-2xl font-semibold text-gray-900 mb-2">{pctFmt(kpiSummary.marginePercent)}</div>
                            <div className="text-xs text-gray-500">
                                Costo Personale: <span className="font-medium">{pctFmt(kpiSummary.incidenzaPersonale)}</span>
                            </div>
                        </div>
                    </div>

                    {/* KPI Secondari Material */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="material-card bg-white rounded-2xl p-5 ripple">
                            <div className="flex items-center gap-3 mb-3">
                                <svg className="w-6 h-6 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                </svg>
                                <div className="text-xs font-medium text-gray-500 uppercase tracking-wide">Costo Personale</div>
                            </div>
                            <div className="text-xl font-semibold text-gray-900 mb-1">{numberFmt(kpiSummary.totaleCostiPersonale)}</div>
                            <div className="text-xs text-gray-500">
                                {pctFmt(kpiSummary.incidenzaPersonale)} dei costi totali
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-2xl p-5 ripple">
                            <div className="flex items-center gap-3 mb-3">
                                <svg className="w-6 h-6 text-teal-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clipRule="evenodd"/>
                                    <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"/>
                                </svg>
                                <div className="text-xs font-medium text-gray-500 uppercase tracking-wide">Costi Operativi</div>
                            </div>
                            <div className="text-xl font-semibold text-gray-900 mb-1">{numberFmt(kpiSummary.totaleCostiOperativi)}</div>
                            <div className="text-xs text-gray-500">
                                {pctFmt((kpiSummary.totaleCostiOperativi / kpiSummary.totaleCosti) * 100)} dei costi totali
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-2xl p-5 ripple">
                            <div className="flex items-center gap-3 mb-3">
                                <svg className="w-6 h-6 text-rose-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                                </svg>
                                <div className="text-xs font-medium text-gray-500 uppercase tracking-wide">Centri di Costo</div>
                            </div>
                            <div className="text-xl font-semibold text-gray-900 mb-1">{CENTRI_DI_COSTO.length}</div>
                            <div className="text-xs text-gray-500">
                                Attivi nel periodo
                            </div>
                        </div>
                    </div>

                    {/* Centri di Costo Material */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {CENTRI_DI_COSTO.map((cdc, index) => {
                            const ricavi = cdc.Consuntivo.Ricavi || 0;
                            const costi = cdc.Consuntivo.Costi || 0;
                            const margine = ricavi - costi;
                            const marginePercent = ricavi ? (margine / ricavi) * 100 : 0;

                            const ricaviAP = cdc.AnnoPrecedente?.Ricavi || 0;
                            const costiAP = cdc.AnnoPrecedente?.Costi || 0;
                            const margineAP = ricaviAP - costiAP;

                            const margineVar = calcVariance(margine, margineAP);

                            return (
                                <div
                                    key={cdc.Nome}
                                    onClick={() => { setSelectedCdc(cdc); setDrawerOpen(true); }}
                                    className={`material-card rounded-2xl border p-5 cursor-pointer ripple bg-white`}
                                >
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex items-center gap-2">
                                            <div dangerouslySetInnerHTML={{ __html: getIconForType(cdc.Tipo) }} className="text-gray-700" />
                                            <div className="font-medium text-gray-900">{cdc.Nome}</div>
                                        </div>
                                        <svg className="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd"/>
                                        </svg>
                                    </div>
                                    <div className="inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-xs font-medium text-gray-700 mb-4">
                                        {cdc.Tipo}
                                    </div>
                                    <div className="space-y-2">
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Ricavi:</span>
                                            <span className="font-semibold text-gray-900">{numberFmt(ricavi)}</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Costi:</span>
                                            <span className="font-semibold text-gray-900">{numberFmt(costi)}</span>
                                        </div>
                                        <div className="flex justify-between text-sm pt-2 border-t border-gray-200">
                                            <span className="text-gray-700 font-medium">Margine:</span>
                                            <span className="font-semibold text-gray-900">{numberFmt(margine)}</span>
                                        </div>
                                        <div className="flex justify-between text-xs">
                                            <span className="text-gray-500">Margine %:</span>
                                            <span className={marginePercent >= 0 ? "text-emerald-600 font-medium" : "text-red-600 font-medium"}>
                                                {pctFmt(marginePercent)}
                                            </span>
                                        </div>
                                        <div className="text-xs pt-1 flex items-center gap-1">
                                            <span className={margineVar >= 0 ? "text-emerald-600 font-medium" : "text-red-600 font-medium"}>
                                                {margineVar >= 0 ? "↑" : "↓"} {pctFmt(Math.abs(margineVar))}
                                            </span>
                                            <span className="text-gray-500">vs Anno Prec.</span>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Drawer Material Bottom Sheet */}
                    {drawerOpen && selectedCdc && (
                        <div className="fixed inset-0 z-50 animate-fadeIn">
                            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setDrawerOpen(false)} />
                            <div className="absolute bottom-0 left-0 w-full h-[75vh] bg-white shadow-2xl overflow-y-auto rounded-t-3xl animate-slideUp">
                                <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-3xl">
                                    <div className="flex items-start justify-between gap-4">
                                        <div className="flex items-center gap-3">
                                            <div dangerouslySetInnerHTML={{ __html: getIconForType(selectedCdc.Tipo) }} className="text-white" />
                                            <div>
                                                <div className="text-xs opacity-75 font-medium uppercase tracking-wide">Dettaglio Centro di Costo</div>
                                                <h2 className="text-xl font-medium">{selectedCdc.Nome}</h2>
                                                <p className="text-sm opacity-90 mt-1">Periodo: {PERIODO} · Tipo: {selectedCdc.Tipo}</p>
                                            </div>
                                        </div>
                                        <button
                                            className="ripple px-4 py-2 rounded-lg bg-white/20 backdrop-blur-sm hover:bg-white/30 transition text-sm font-medium"
                                            onClick={() => setDrawerOpen(false)}
                                        >
                                            Chiudi
                                        </button>
                                    </div>
                                </div>

                                {/* Tabella comparativa Material */}
                                <div className="p-6">
                                    <div className="material-card bg-white rounded-2xl overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="border-b-2 border-blue-500 bg-gray-50">
                                                        <th className="py-3 px-4 text-left font-medium text-gray-700 uppercase text-xs tracking-wide">Voce</th>
                                                        <th className="py-3 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Consuntivo</th>
                                                        <th className="py-3 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Budget</th>
                                                        <th className="py-3 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Anno Prec.</th>
                                                        <th className="py-3 px-4 text-right font-medium text-gray-700 uppercase text-xs tracking-wide">Δ Budget</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {Object.keys(selectedCdc.Consuntivo).map((voce) => {
                                                        const consuntivo = selectedCdc.Consuntivo[voce];
                                                        const budget = selectedCdc.Budget?.[voce] || 0;
                                                        const annoPrecedente = selectedCdc.AnnoPrecedente?.[voce] || 0;
                                                        const variance = calcVariance(consuntivo, budget);
                                                        const isPercentage = voce.includes("%");

                                                        return (
                                                            <tr key={voce} className="border-b border-gray-200 hover:bg-gray-50 transition">
                                                                <td className="py-3 px-4 font-medium text-gray-900">{voce}</td>
                                                                <td className="py-3 px-4 text-right font-semibold text-gray-900">
                                                                    {isPercentage ? pctFmt(consuntivo) : numberFmt(consuntivo)}
                                                                </td>
                                                                <td className="py-3 px-4 text-right text-gray-600">
                                                                    {isPercentage ? pctFmt(budget) : numberFmt(budget)}
                                                                </td>
                                                                <td className="py-3 px-4 text-right text-gray-500">
                                                                    {isPercentage ? pctFmt(annoPrecedente) : numberFmt(annoPrecedente)}
                                                                </td>
                                                                <td className={`py-3 px-4 text-right font-medium ${variance >= 0 ? "text-emerald-600" : "text-red-600"}`}>
                                                                    {!isPercentage && (variance >= 0 ? "↑" : "↓")} {pctFmt(Math.abs(variance))}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer Material */}
                    <div className="material-card bg-white rounded-2xl p-4 border-l-4 border-gray-400">
                        <div className="flex items-center gap-2 text-xs text-gray-600">
                            <svg className="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"/>
                            </svg>
                            <span className="font-medium">Dati caricati da:</span>
                            <span className="text-blue-600">{new URLSearchParams(window.location.search).get('data') || 'bcdc.json'}</span>
                            <span className="text-gray-400">|</span>
                            <span>Usa <code className="px-1 py-0.5 bg-gray-100 rounded text-xs">?data=nome_file.json</code> per caricare periodi diversi</span>
                        </div>
                    </div>
                    </div>
                </div>
            );
        }

        // Mount
        function App() { return <BcdcDashboard />; }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>

<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Fatturato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Roboto', sans-serif; }
        .material-card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        .material-card:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            transform: translateY(-2px);
        }
        .material-card-elevated {
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:active::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: ripple-animation 0.6s ease-out;
        }
        @keyframes ripple-animation {
            to { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    </style>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react">
        const { useMemo, useState, useEffect } = React;

        // Variabili globali per i dati
        let PERIODO = "";
        let CATEGORIE = [];
        let CLIENTI_TOP = [];
        let PRODOTTI_TOP = [];

        function numberFmt(val) {
            return val.toLocaleString("it-IT", {
                style: "currency",
                currency: "EUR",
                maximumFractionDigits: 0
            });
        }

        function pctFmt(val) { return `${val.toFixed(1)}%`; }

        function calcVariance(actual, target) {
            if (!target) return 0;
            return ((actual - target) / target) * 100;
        }

        // Palette colori rotativi
        const COLOR_PALETTE = [
            "bg-blue-50 border-blue-200",
            "bg-green-50 border-green-200",
            "bg-purple-50 border-purple-200",
            "bg-orange-50 border-orange-200",
            "bg-cyan-50 border-cyan-200",
            "bg-yellow-50 border-yellow-200",
            "bg-pink-50 border-pink-200",
            "bg-indigo-50 border-indigo-200",
            "bg-red-50 border-red-200",
            "bg-teal-50 border-teal-200"
        ];

        // Icone Material Design per categoria
        const DEFAULT_ICONS = {
            "Prodotti": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>,
            "Servizi": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>,
            "Consulenze": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"/></svg>,
            "Manutenzione": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22.61 18.99l-9.08-9.08c.93-2.34.45-5.1-1.44-7C9.79.61 6.21.4 3.66 2.26L7.5 6.11 6.08 7.52 2.25 3.69C.39 6.23.6 9.82 2.9 12.11c1.86 1.86 4.57 2.35 6.89 1.48l9.11 9.11c.39.39 1.02.39 1.41 0l2.3-2.3c.4-.38.4-1.01 0-1.41zm-3 1.6l-9.46-9.46c-.61.45-1.29.72-2 .82-1.36.2-2.79-.21-3.83-1.25C3.37 9.76 2.93 8.5 3 7.26l3.09 3.09 4.24-4.24-3.09-3.09c1.24-.07 2.49.37 3.44 1.31 1.08 1.08 1.49 2.57 1.24 3.96-.12.71-.42 1.37-.88 1.96l9.45 9.45-.88.89z"/></svg>,
            "Software": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>,
            "Hardware": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg>,
            "Licenze": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>,
            "Formazione": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>,
            "Altro": <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2.5 2.1h-15V5h15v14.1zm0-16.1h-15c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
        };

        const ICON_COLORS = {
            "Prodotti": "text-blue-600",
            "Servizi": "text-green-600",
            "Consulenze": "text-purple-600",
            "Manutenzione": "text-orange-600",
            "Software": "text-cyan-600",
            "Hardware": "text-yellow-700",
            "Licenze": "text-pink-600",
            "Formazione": "text-indigo-600",
            "Altro": "text-teal-600"
        };

        function getColorForIndex(index) {
            return COLOR_PALETTE[index % COLOR_PALETTE.length];
        }

        function getIconForType(tipo) {
            return DEFAULT_ICONS[tipo] || DEFAULT_ICONS["Altro"];
        }

        function getIconColorForType(tipo) {
            return ICON_COLORS[tipo] || "text-gray-600";
        }

        function FatturatoDashboard() {
            const [selectedCategoria, setSelectedCategoria] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [activeTab, setActiveTab] = useState("categorie");
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);

            // Carica dati dal JSON
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const dataFile = urlParams.get('data') || 'fatturato.json';

                console.log(`Caricamento dati da: ${dataFile}`);

                fetch(`./${dataFile}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - File non trovato: ${dataFile}`);
                        }
                        return response.json();
                    })
                    .then(jsonData => {
                        PERIODO = jsonData.Periodo;
                        CATEGORIE = jsonData.Categorie;
                        CLIENTI_TOP = jsonData.ClientiTop || [];
                        PRODOTTI_TOP = jsonData.ProdottiTop || [];
                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Errore caricamento dati:', err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            const kpiSummary = useMemo(() => {
                if (!data) return null;

                let totaleFatturato = 0;
                let totaleFatturatoAP = 0;
                let totaleFatturatoBudget = 0;
                let numeroFatture = 0;
                let numeroClienti = new Set();

                CATEGORIE.forEach(cat => {
                    totaleFatturato += cat.Consuntivo.Fatturato || 0;
                    totaleFatturatoAP += cat.AnnoPrecedente?.Fatturato || 0;
                    totaleFatturatoBudget += cat.Budget?.Fatturato || 0;
                    numeroFatture += cat.Consuntivo.NumeroFatture || 0;

                    if (cat.Consuntivo.Clienti) {
                        cat.Consuntivo.Clienti.forEach(c => numeroClienti.add(c));
                    }
                });

                const ticketMedio = numeroFatture > 0 ? totaleFatturato / numeroFatture : 0;
                const fatturatoPerCliente = numeroClienti.size > 0 ? totaleFatturato / numeroClienti.size : 0;

                // Priorità: Anno Precedente > Budget
                const compareTo = totaleFatturatoAP || totaleFatturatoBudget;
                const compareLabel = totaleFatturatoAP ? "Anno Prec." : "Budget";

                return {
                    totaleFatturato,
                    compareTo,
                    compareLabel,
                    variance: calcVariance(totaleFatturato, compareTo),
                    numeroFatture,
                    numeroClienti: numeroClienti.size,
                    ticketMedio,
                    fatturatoPerCliente
                };
            }, [data]);

            if (loading) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
                            <div className="text-xl font-medium text-gray-700">Caricamento dati fatturato...</div>
                            <div className="text-sm text-gray-500 mt-2">Attendere prego</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center max-w-md material-card-elevated bg-white rounded-lg p-8">
                            <svg className="w-16 h-16 text-red-500 mx-auto mb-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <div className="text-xl font-medium mb-3 text-red-600">Errore caricamento dati</div>
                            <div className="text-gray-700 mb-4">{error}</div>
                            <div className="text-sm text-gray-500">Assicurati che il file JSON sia presente nella directory.</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full min-h-screen bg-gray-50">
                    {/* Material Design AppBar */}
                    <div className="bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg">
                        <div className="max-w-7xl mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                                    </svg>
                                    <div>
                                        <h1 className="text-xl font-medium">Dashboard Fatturato</h1>
                                        <p className="text-sm text-green-100">Periodo: {PERIODO} · Valuta: EUR</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded text-sm font-medium">Consuntivo</div>
                                    <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded text-sm font-medium">Budget</div>
                                    <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded text-sm font-medium">Anno Prec.</div>
                                </div>
                            </div>
                            {selectedCategoria && (
                                <div className="mt-3 flex items-center gap-2 text-sm text-green-100">
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                    </svg>
                                    <span>Panoramica</span>
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                    </svg>
                                    <span className="font-medium text-white">{selectedCategoria.Nome}</span>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-6 space-y-6">

                    {/* KPI Cards - Material Design */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-emerald-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Fatturato Totale</div>
                                <svg className="w-6 h-6 text-emerald-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{numberFmt(kpiSummary.totaleFatturato)}</div>
                            <div className="mt-3 flex items-center gap-2">
                                <div className={`flex items-center gap-1 text-sm font-medium ${kpiSummary.variance >= 0 ? "text-green-600" : "text-red-600"}`}>
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d={kpiSummary.variance >= 0 ? "M7 14l5-5 5 5z" : "M7 10l5 5 5-5z"}/>
                                    </svg>
                                    <span>{pctFmt(Math.abs(kpiSummary.variance))}</span>
                                </div>
                                <span className="text-sm text-gray-500">vs {kpiSummary.compareLabel}</span>
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-blue-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Numero Fatture</div>
                                <svg className="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{kpiSummary.numeroFatture}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                Ticket Medio: <span className="font-medium text-gray-700">{numberFmt(kpiSummary.ticketMedio)}</span>
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-purple-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Clienti Attivi</div>
                                <svg className="w-6 h-6 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{kpiSummary.numeroClienti}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                Fatturato/Cliente: <span className="font-medium text-gray-700">{numberFmt(kpiSummary.fatturatoPerCliente)}</span>
                            </div>
                        </div>

                        <div className="material-card bg-white rounded-lg p-6 border-l-4 border-amber-500">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-sm font-medium text-gray-600 uppercase tracking-wide">Categorie</div>
                                <svg className="w-6 h-6 text-amber-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2l-5.5 9h11z"/><circle cx="17.5" cy="17.5" r="4.5"/><path d="M3 13.5h8v8H3z"/>
                                </svg>
                            </div>
                            <div className="text-3xl font-bold text-gray-900">{CATEGORIE.length}</div>
                            <div className="mt-3 text-sm text-gray-500">
                                Attive nel periodo
                            </div>
                        </div>
                    </div>

                    {/* Tabs Material Design */}
                    <div className="material-card bg-white rounded-lg p-2">
                        <div className="flex gap-2">
                            <button
                                onClick={() => setActiveTab("categorie")}
                                className={`ripple flex-1 px-4 py-2 rounded-lg text-sm font-medium transition ${
                                    activeTab === "categorie"
                                        ? "bg-green-600 text-white shadow-lg"
                                        : "bg-gray-50 text-gray-700 hover:bg-gray-100"
                                }`}
                            >
                                Categorie
                            </button>
                            <button
                                onClick={() => setActiveTab("clienti")}
                                className={`ripple flex-1 px-4 py-2 rounded-lg text-sm font-medium transition ${
                                    activeTab === "clienti"
                                        ? "bg-green-600 text-white shadow-lg"
                                        : "bg-gray-50 text-gray-700 hover:bg-gray-100"
                                }`}
                            >
                                Top Clienti
                            </button>
                            <button
                                onClick={() => setActiveTab("prodotti")}
                                className={`ripple flex-1 px-4 py-2 rounded-lg text-sm font-medium transition ${
                                    activeTab === "prodotti"
                                        ? "bg-green-600 text-white shadow-lg"
                                        : "bg-gray-50 text-gray-700 hover:bg-gray-100"
                                }`}
                            >
                                Top Prodotti
                            </button>
                        </div>
                    </div>

                    {/* Tab Content - Categorie */}
                    {activeTab === "categorie" && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {CATEGORIE.map((cat, index) => {
                                const fatturato = cat.Consuntivo.Fatturato || 0;
                                const fatturatoAP = cat.AnnoPrecedente?.Fatturato || 0;
                                const fatturatoBudget = cat.Budget?.Fatturato || 0;

                                const compareTo = fatturatoAP || fatturatoBudget;
                                const variance = calcVariance(fatturato, compareTo);

                                const numeroFatture = cat.Consuntivo.NumeroFatture || 0;
                                const ticketMedio = numeroFatture > 0 ? fatturato / numeroFatture : 0;

                                return (
                                    <div
                                        key={cat.Nome}
                                        onClick={() => { setSelectedCategoria(cat); setDrawerOpen(true); }}
                                        className={`material-card bg-white rounded-lg p-5 cursor-pointer ripple ${getColorForIndex(index)}`}
                                    >
                                        <div className="flex items-center gap-3 mb-3">
                                            <div className={getIconColorForType(cat.Tipo)}>
                                                {getIconForType(cat.Tipo)}
                                            </div>
                                            <div>
                                                <div className="text-lg font-medium text-gray-900">{cat.Nome}</div>
                                                <div className="text-xs text-gray-500">{cat.Tipo}</div>
                                            </div>
                                        </div>
                                        <div className="space-y-1">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-600">Fatturato:</span>
                                                <span className="font-semibold">{numberFmt(fatturato)}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-600">N. Fatture:</span>
                                                <span className="font-semibold">{numeroFatture}</span>
                                            </div>
                                            <div className="flex justify-between text-sm pt-1 border-t">
                                                <span className="text-gray-600">Ticket Medio:</span>
                                                <span className="font-semibold">{numberFmt(ticketMedio)}</span>
                                            </div>
                                            <div className="text-xs text-gray-500 pt-1">
                                                <span className={variance >= 0 ? "text-green-600" : "text-red-600"}>
                                                    {variance >= 0 ? "▲" : "▼"} {pctFmt(Math.abs(variance))} vs {fatturatoAP ? "Anno Prec." : "Budget"}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Tab Content - Top Clienti */}
                    {activeTab === "clienti" && (
                        <div className="rounded-2xl border shadow-sm bg-white overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50 border-b">
                                        <tr>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Pos.</th>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Cliente</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Fatturato</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">N. Fatture</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Ticket Medio</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">% su Totale</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {CLIENTI_TOP.map((cliente, index) => {
                                            const percentuale = (cliente.Fatturato / kpiSummary.totaleFatturato) * 100;
                                            const ticketMedio = cliente.NumeroFatture > 0 ? cliente.Fatturato / cliente.NumeroFatture : 0;

                                            return (
                                                <tr key={cliente.Nome} className="border-b hover:bg-gray-50">
                                                    <td className="py-3 px-4 text-sm">
                                                        <span className={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold ${
                                                            index === 0 ? "bg-yellow-100 text-yellow-800" :
                                                            index === 1 ? "bg-gray-100 text-gray-800" :
                                                            index === 2 ? "bg-orange-100 text-orange-800" :
                                                            "bg-blue-50 text-blue-700"
                                                        }`}>
                                                            {index + 1}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-4 text-sm font-medium">{cliente.Nome}</td>
                                                    <td className="py-3 px-4 text-sm text-right font-semibold">{numberFmt(cliente.Fatturato)}</td>
                                                    <td className="py-3 px-4 text-sm text-right text-gray-600">{cliente.NumeroFatture}</td>
                                                    <td className="py-3 px-4 text-sm text-right text-gray-600">{numberFmt(ticketMedio)}</td>
                                                    <td className="py-3 px-4 text-sm text-right font-medium text-blue-600">{pctFmt(percentuale)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Tab Content - Top Prodotti */}
                    {activeTab === "prodotti" && (
                        <div className="rounded-2xl border shadow-sm bg-white overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50 border-b">
                                        <tr>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Pos.</th>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Prodotto/Servizio</th>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Categoria</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Fatturato</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Quantità</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Prezzo Medio</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">% su Totale</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {PRODOTTI_TOP.map((prodotto, index) => {
                                            const percentuale = (prodotto.Fatturato / kpiSummary.totaleFatturato) * 100;
                                            const prezzoMedio = prodotto.Quantita > 0 ? prodotto.Fatturato / prodotto.Quantita : 0;

                                            return (
                                                <tr key={prodotto.Nome} className="border-b hover:bg-gray-50">
                                                    <td className="py-3 px-4 text-sm">
                                                        <span className={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold ${
                                                            index === 0 ? "bg-yellow-100 text-yellow-800" :
                                                            index === 1 ? "bg-gray-100 text-gray-800" :
                                                            index === 2 ? "bg-orange-100 text-orange-800" :
                                                            "bg-blue-50 text-blue-700"
                                                        }`}>
                                                            {index + 1}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-4 text-sm font-medium">{prodotto.Nome}</td>
                                                    <td className="py-3 px-4 text-sm text-gray-600">{prodotto.Categoria}</td>
                                                    <td className="py-3 px-4 text-sm text-right font-semibold">{numberFmt(prodotto.Fatturato)}</td>
                                                    <td className="py-3 px-4 text-sm text-right text-gray-600">{prodotto.Quantita}</td>
                                                    <td className="py-3 px-4 text-sm text-right text-gray-600">{numberFmt(prezzoMedio)}</td>
                                                    <td className="py-3 px-4 text-sm text-right font-medium text-blue-600">{pctFmt(percentuale)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Material Bottom Sheet */}
                    {drawerOpen && selectedCategoria && (
                        <div className="fixed inset-0 z-50 animate-fadeIn">
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={() => setDrawerOpen(false)} />
                            <div className="absolute bottom-0 left-0 w-full h-[75vh] bg-white shadow-2xl overflow-hidden animate-slideUp">
                                <div className="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-5 shadow-md">
                                    <div className="flex items-start justify-between gap-4">
                                        <div className="flex items-center gap-3">
                                            <div className="text-white">
                                                {getIconForType(selectedCategoria.Tipo)}
                                            </div>
                                            <div>
                                                <div className="text-xs text-green-100 uppercase tracking-wide">Dettaglio Categoria</div>
                                                <h2 className="text-2xl font-medium mt-1">{selectedCategoria.Nome}</h2>
                                                <p className="text-sm text-green-100 mt-1">Periodo: {PERIODO} · Tipo: {selectedCategoria.Tipo}</p>
                                            </div>
                                        </div>
                                        <button
                                            className="ripple bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all"
                                            onClick={() => setDrawerOpen(false)}
                                        >
                                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                            </svg>
                                            <span className="font-medium">Chiudi</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="p-6 overflow-y-auto h-[calc(100%-110px)]">

                                {/* Tabella comparativa */}
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="text-left border-b-2">
                                                <th className="py-2 pr-4">Voce</th>
                                                <th className="py-2 pr-4 text-right">Consuntivo</th>
                                                <th className="py-2 pr-4 text-right">Budget</th>
                                                <th className="py-2 pr-4 text-right">Anno Prec.</th>
                                                <th className="py-2 pr-4 text-right">Δ Budget</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.keys(selectedCategoria.Consuntivo).filter(k => k !== "Clienti").map((voce) => {
                                                const consuntivo = selectedCategoria.Consuntivo[voce];
                                                const budget = selectedCategoria.Budget?.[voce] || 0;
                                                const annoPrecedente = selectedCategoria.AnnoPrecedente?.[voce] || 0;
                                                const variance = calcVariance(consuntivo, budget);
                                                const isPercentage = voce.includes("%");

                                                return (
                                                    <tr key={voce} className="border-b hover:bg-gray-50">
                                                        <td className="py-2 pr-4">{voce}</td>
                                                        <td className="py-2 pr-4 text-right">
                                                            {isPercentage ? pctFmt(consuntivo) : numberFmt(consuntivo)}
                                                        </td>
                                                        <td className="py-2 pr-4 text-right text-gray-600">
                                                            {isPercentage ? pctFmt(budget) : numberFmt(budget)}
                                                        </td>
                                                        <td className="py-2 pr-4 text-right text-gray-500">
                                                            {isPercentage ? pctFmt(annoPrecedente) : numberFmt(annoPrecedente)}
                                                        </td>
                                                        <td className={`py-2 pr-4 text-right ${variance >= 0 ? "text-green-600" : "text-red-600"}`}>
                                                            {!isPercentage && (variance >= 0 ? "▲" : "▼")} {pctFmt(Math.abs(variance))}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer Material */}
                    <div className="material-card bg-white rounded-lg p-4 flex items-center gap-3 text-sm text-gray-600">
                        <svg className="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/>
                        </svg>
                        <div>
                            <span className="font-medium">Dati caricati da:</span> {new URLSearchParams(window.location.search).get('data') || 'fatturato.json'}
                            <span className="mx-2">·</span>
                            <span className="text-gray-500">Usa ?data=nome_file.json per caricare periodi diversi</span>
                        </div>
                    </div>
                </div>
            </div>
            );
        }

        // Mount
        function App() { return <FatturatoDashboard />; }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>

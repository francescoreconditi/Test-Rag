<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Fatturato</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react">
        const { useMemo, useState, useEffect } = React;

        // Variabili globali per i dati
        let PERIODO = "";
        let CATEGORIE = [];
        let CLIENTI_TOP = [];
        let PRODOTTI_TOP = [];

        function numberFmt(val) {
            return val.toLocaleString("it-IT", {
                style: "currency",
                currency: "EUR",
                maximumFractionDigits: 0
            });
        }

        function pctFmt(val) { return `${val.toFixed(1)}%`; }

        function calcVariance(actual, target) {
            if (!target) return 0;
            return ((actual - target) / target) * 100;
        }

        // Palette colori rotativi
        const COLOR_PALETTE = [
            "bg-blue-50 border-blue-200",
            "bg-green-50 border-green-200",
            "bg-purple-50 border-purple-200",
            "bg-orange-50 border-orange-200",
            "bg-cyan-50 border-cyan-200",
            "bg-yellow-50 border-yellow-200",
            "bg-pink-50 border-pink-200",
            "bg-indigo-50 border-indigo-200",
            "bg-red-50 border-red-200",
            "bg-teal-50 border-teal-200"
        ];

        // Icone di default per categoria
        const DEFAULT_ICONS = {
            "Prodotti": "📦",
            "Servizi": "🔧",
            "Consulenze": "💼",
            "Manutenzione": "🛠️",
            "Software": "💻",
            "Hardware": "🖥️",
            "Licenze": "📜",
            "Formazione": "📚",
            "Altro": "📊"
        };

        function getColorForIndex(index) {
            return COLOR_PALETTE[index % COLOR_PALETTE.length];
        }

        function getIconForType(tipo) {
            return DEFAULT_ICONS[tipo] || "📊";
        }

        function FatturatoDashboard() {
            const [selectedCategoria, setSelectedCategoria] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [activeTab, setActiveTab] = useState("categorie");
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);

            // Carica dati dal JSON
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const dataFile = urlParams.get('data') || 'fatturato.json';

                console.log(`Caricamento dati da: ${dataFile}`);

                fetch(`./${dataFile}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - File non trovato: ${dataFile}`);
                        }
                        return response.json();
                    })
                    .then(jsonData => {
                        PERIODO = jsonData.Periodo;
                        CATEGORIE = jsonData.Categorie;
                        CLIENTI_TOP = jsonData.ClientiTop || [];
                        PRODOTTI_TOP = jsonData.ProdottiTop || [];
                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Errore caricamento dati:', err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            const kpiSummary = useMemo(() => {
                if (!data) return null;

                let totaleFatturato = 0;
                let totaleFatturatoAP = 0;
                let totaleFatturatoBudget = 0;
                let numeroFatture = 0;
                let numeroClienti = new Set();

                CATEGORIE.forEach(cat => {
                    totaleFatturato += cat.Consuntivo.Fatturato || 0;
                    totaleFatturatoAP += cat.AnnoPrecedente?.Fatturato || 0;
                    totaleFatturatoBudget += cat.Budget?.Fatturato || 0;
                    numeroFatture += cat.Consuntivo.NumeroFatture || 0;

                    if (cat.Consuntivo.Clienti) {
                        cat.Consuntivo.Clienti.forEach(c => numeroClienti.add(c));
                    }
                });

                const ticketMedio = numeroFatture > 0 ? totaleFatturato / numeroFatture : 0;
                const fatturatoPerCliente = numeroClienti.size > 0 ? totaleFatturato / numeroClienti.size : 0;

                // Priorità: Anno Precedente > Budget
                const compareTo = totaleFatturatoAP || totaleFatturatoBudget;
                const compareLabel = totaleFatturatoAP ? "Anno Prec." : "Budget";

                return {
                    totaleFatturato,
                    compareTo,
                    compareLabel,
                    variance: calcVariance(totaleFatturato, compareTo),
                    numeroFatture,
                    numeroClienti: numeroClienti.size,
                    ticketMedio,
                    fatturatoPerCliente
                };
            }, [data]);

            if (loading) {
                return (
                    <div className="w-full h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-2xl font-semibold mb-2">Caricamento dati fatturato...</div>
                            <div className="text-gray-500">Attendere prego</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="w-full h-screen flex items-center justify-center">
                        <div className="text-center max-w-md">
                            <div className="text-2xl font-semibold mb-2 text-red-600">Errore caricamento dati</div>
                            <div className="text-gray-700 mb-4">{error}</div>
                            <div className="text-sm text-gray-500">Assicurati che il file JSON sia presente nella directory.</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full p-6 space-y-6">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h1 className="text-2xl font-semibold">Dashboard Fatturato</h1>
                            <p className="text-sm text-gray-600">Periodo: {PERIODO} · Valuta: EUR</p>
                            <div className="mt-2 text-sm text-gray-700">
                                <span className="font-medium">Percorso:</span>{" "}
                                <span>
                                    Panoramica Fatturato
                                    {selectedCategoria && <> → <span className="font-medium">{selectedCategoria.Nome}</span></>}
                                </span>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <div className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">Consuntivo</div>
                            <div className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">Budget</div>
                            <div className="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm">Anno Prec.</div>
                        </div>
                    </div>

                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">Fatturato Totale</div>
                            <div className="text-2xl font-semibold">{numberFmt(kpiSummary.totaleFatturato)}</div>
                            <div className="mt-2 text-xs">
                                <span className={kpiSummary.variance >= 0 ? "text-green-600" : "text-red-600"}>
                                    {kpiSummary.variance >= 0 ? "▲" : "▼"} {pctFmt(Math.abs(kpiSummary.variance))} vs {kpiSummary.compareLabel}
                                </span>
                            </div>
                        </div>

                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">Numero Fatture</div>
                            <div className="text-2xl font-semibold">{kpiSummary.numeroFatture}</div>
                            <div className="mt-2 text-xs text-gray-500">
                                Ticket Medio: {numberFmt(kpiSummary.ticketMedio)}
                            </div>
                        </div>

                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">Clienti Attivi</div>
                            <div className="text-2xl font-semibold">{kpiSummary.numeroClienti}</div>
                            <div className="mt-2 text-xs text-gray-500">
                                Fatturato/Cliente: {numberFmt(kpiSummary.fatturatoPerCliente)}
                            </div>
                        </div>

                        <div className="rounded-2xl border p-4 shadow-sm bg-white">
                            <div className="text-sm text-gray-500">Categorie</div>
                            <div className="text-2xl font-semibold">{CATEGORIE.length}</div>
                            <div className="mt-2 text-xs text-gray-500">
                                Attive nel periodo
                            </div>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="border-b border-gray-200">
                        <div className="flex gap-4">
                            <button
                                onClick={() => setActiveTab("categorie")}
                                className={`pb-2 px-1 text-sm font-medium border-b-2 transition ${
                                    activeTab === "categorie"
                                        ? "border-blue-600 text-blue-600"
                                        : "border-transparent text-gray-500 hover:text-gray-700"
                                }`}
                            >
                                Categorie
                            </button>
                            <button
                                onClick={() => setActiveTab("clienti")}
                                className={`pb-2 px-1 text-sm font-medium border-b-2 transition ${
                                    activeTab === "clienti"
                                        ? "border-blue-600 text-blue-600"
                                        : "border-transparent text-gray-500 hover:text-gray-700"
                                }`}
                            >
                                Top Clienti
                            </button>
                            <button
                                onClick={() => setActiveTab("prodotti")}
                                className={`pb-2 px-1 text-sm font-medium border-b-2 transition ${
                                    activeTab === "prodotti"
                                        ? "border-blue-600 text-blue-600"
                                        : "border-transparent text-gray-500 hover:text-gray-700"
                                }`}
                            >
                                Top Prodotti
                            </button>
                        </div>
                    </div>

                    {/* Tab Content - Categorie */}
                    {activeTab === "categorie" && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {CATEGORIE.map((cat, index) => {
                                const fatturato = cat.Consuntivo.Fatturato || 0;
                                const fatturatoAP = cat.AnnoPrecedente?.Fatturato || 0;
                                const fatturatoBudget = cat.Budget?.Fatturato || 0;

                                const compareTo = fatturatoAP || fatturatoBudget;
                                const variance = calcVariance(fatturato, compareTo);

                                const numeroFatture = cat.Consuntivo.NumeroFatture || 0;
                                const ticketMedio = numeroFatture > 0 ? fatturato / numeroFatture : 0;

                                return (
                                    <div
                                        key={cat.Nome}
                                        onClick={() => { setSelectedCategoria(cat); setDrawerOpen(true); }}
                                        className={`rounded-2xl border p-4 shadow-sm cursor-pointer hover:shadow-md transition ${getColorForIndex(index)}`}
                                    >
                                        <div className="flex items-center justify-between mb-2">
                                            <div className="text-lg font-medium">{getIconForType(cat.Tipo)} {cat.Nome}</div>
                                            <span className="text-xs text-blue-600 underline">Dettagli →</span>
                                        </div>
                                        <div className="text-sm text-gray-600 mb-3">{cat.Tipo}</div>
                                        <div className="space-y-1">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-600">Fatturato:</span>
                                                <span className="font-semibold">{numberFmt(fatturato)}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-600">N. Fatture:</span>
                                                <span className="font-semibold">{numeroFatture}</span>
                                            </div>
                                            <div className="flex justify-between text-sm pt-1 border-t">
                                                <span className="text-gray-600">Ticket Medio:</span>
                                                <span className="font-semibold">{numberFmt(ticketMedio)}</span>
                                            </div>
                                            <div className="text-xs text-gray-500 pt-1">
                                                <span className={variance >= 0 ? "text-green-600" : "text-red-600"}>
                                                    {variance >= 0 ? "▲" : "▼"} {pctFmt(Math.abs(variance))} vs {fatturatoAP ? "Anno Prec." : "Budget"}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Tab Content - Top Clienti */}
                    {activeTab === "clienti" && (
                        <div className="rounded-2xl border shadow-sm bg-white overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50 border-b">
                                        <tr>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Pos.</th>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Cliente</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Fatturato</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">N. Fatture</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Ticket Medio</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">% su Totale</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {CLIENTI_TOP.map((cliente, index) => {
                                            const percentuale = (cliente.Fatturato / kpiSummary.totaleFatturato) * 100;
                                            const ticketMedio = cliente.NumeroFatture > 0 ? cliente.Fatturato / cliente.NumeroFatture : 0;

                                            return (
                                                <tr key={cliente.Nome} className="border-b hover:bg-gray-50">
                                                    <td className="py-3 px-4 text-sm">
                                                        <span className={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold ${
                                                            index === 0 ? "bg-yellow-100 text-yellow-800" :
                                                            index === 1 ? "bg-gray-100 text-gray-800" :
                                                            index === 2 ? "bg-orange-100 text-orange-800" :
                                                            "bg-blue-50 text-blue-700"
                                                        }`}>
                                                            {index + 1}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-4 text-sm font-medium">{cliente.Nome}</td>
                                                    <td className="py-3 px-4 text-sm text-right font-semibold">{numberFmt(cliente.Fatturato)}</td>
                                                    <td className="py-3 px-4 text-sm text-right text-gray-600">{cliente.NumeroFatture}</td>
                                                    <td className="py-3 px-4 text-sm text-right text-gray-600">{numberFmt(ticketMedio)}</td>
                                                    <td className="py-3 px-4 text-sm text-right font-medium text-blue-600">{pctFmt(percentuale)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Tab Content - Top Prodotti */}
                    {activeTab === "prodotti" && (
                        <div className="rounded-2xl border shadow-sm bg-white overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50 border-b">
                                        <tr>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Pos.</th>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Prodotto/Servizio</th>
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">Categoria</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Fatturato</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Quantità</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">Prezzo Medio</th>
                                            <th className="py-3 px-4 text-right text-sm font-semibold text-gray-700">% su Totale</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {PRODOTTI_TOP.map((prodotto, index) => {
                                            const percentuale = (prodotto.Fatturato / kpiSummary.totaleFatturato) * 100;
                                            const prezzoMedio = prodotto.Quantita > 0 ? prodotto.Fatturato / prodotto.Quantita : 0;

                                            return (
                                                <tr key={prodotto.Nome} className="border-b hover:bg-gray-50">
                                                    <td className="py-3 px-4 text-sm">
                                                        <span className={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold ${
                                                            index === 0 ? "bg-yellow-100 text-yellow-800" :
                                                            index === 1 ? "bg-gray-100 text-gray-800" :
                                                            index === 2 ? "bg-orange-100 text-orange-800" :
                                                            "bg-blue-50 text-blue-700"
                                                        }`}>
                                                            {index + 1}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-4 text-sm font-medium">{prodotto.Nome}</td>
                                                    <td className="py-3 px-4 text-sm text-gray-600">{prodotto.Categoria}</td>
                                                    <td className="py-3 px-4 text-sm text-right font-semibold">{numberFmt(prodotto.Fatturato)}</td>
                                                    <td className="py-3 px-4 text-sm text-right text-gray-600">{prodotto.Quantita}</td>
                                                    <td className="py-3 px-4 text-sm text-right text-gray-600">{numberFmt(prezzoMedio)}</td>
                                                    <td className="py-3 px-4 text-sm text-right font-medium text-blue-600">{pctFmt(percentuale)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Drawer dettaglio categoria */}
                    {drawerOpen && selectedCategoria && (
                        <div className="fixed inset-0 z-40">
                            <div className="absolute inset-0 bg-black/30" onClick={() => setDrawerOpen(false)} />
                            <div className="absolute bottom-0 left-0 w-full h-[70vh] bg-white shadow-2xl p-6 overflow-y-auto rounded-t-2xl">
                                <div className="flex items-start justify-between gap-4 mb-6">
                                    <div>
                                        <div className="text-xs text-gray-500">Dettaglio Categoria</div>
                                        <h2 className="text-xl font-semibold">{getIconForType(selectedCategoria.Tipo)} {selectedCategoria.Nome}</h2>
                                        <p className="text-sm text-gray-600 mt-1">Periodo: {PERIODO} · Tipo: {selectedCategoria.Tipo}</p>
                                    </div>
                                    <button className="text-sm px-3 py-1 rounded-md border hover:bg-gray-50" onClick={() => setDrawerOpen(false)}>
                                        Chiudi
                                    </button>
                                </div>

                                {/* Tabella comparativa */}
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="text-left border-b-2">
                                                <th className="py-2 pr-4">Voce</th>
                                                <th className="py-2 pr-4 text-right">Consuntivo</th>
                                                <th className="py-2 pr-4 text-right">Budget</th>
                                                <th className="py-2 pr-4 text-right">Anno Prec.</th>
                                                <th className="py-2 pr-4 text-right">Δ Budget</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.keys(selectedCategoria.Consuntivo).filter(k => k !== "Clienti").map((voce) => {
                                                const consuntivo = selectedCategoria.Consuntivo[voce];
                                                const budget = selectedCategoria.Budget?.[voce] || 0;
                                                const annoPrecedente = selectedCategoria.AnnoPrecedente?.[voce] || 0;
                                                const variance = calcVariance(consuntivo, budget);
                                                const isPercentage = voce.includes("%");

                                                return (
                                                    <tr key={voce} className="border-b hover:bg-gray-50">
                                                        <td className="py-2 pr-4">{voce}</td>
                                                        <td className="py-2 pr-4 text-right">
                                                            {isPercentage ? pctFmt(consuntivo) : numberFmt(consuntivo)}
                                                        </td>
                                                        <td className="py-2 pr-4 text-right text-gray-600">
                                                            {isPercentage ? pctFmt(budget) : numberFmt(budget)}
                                                        </td>
                                                        <td className="py-2 pr-4 text-right text-gray-500">
                                                            {isPercentage ? pctFmt(annoPrecedente) : numberFmt(annoPrecedente)}
                                                        </td>
                                                        <td className={`py-2 pr-4 text-right ${variance >= 0 ? "text-green-600" : "text-red-600"}`}>
                                                            {!isPercentage && (variance >= 0 ? "▲" : "▼")} {pctFmt(Math.abs(variance))}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <div className="text-xs text-gray-500">
                        Dati caricati da: {new URLSearchParams(window.location.search).get('data') || 'fatturato.json'} |
                        Suggerimento: usa ?data=nome_file.json per caricare periodi diversi
                    </div>
                </div>
            );
        }

        // Mount
        function App() { return <FatturatoDashboard />; }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>
